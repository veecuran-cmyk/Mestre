<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mestre OS - Corrigido</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
:root {
  --primary: #6200ea;
  --primary-contrast: #ffffff;
  --bg-main: #000000;
  --bg-surface: #121212;
  --bg-card: #1e1e1e;
  --text-main: #ffffff;
  --text-sub: #b0b0b0;
  --border: #333333;
  --input-bg: #2c2c2c;
  --danger: #d50000;
  --success: #00c853;
}
*{box-sizing:border-box}
body {
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--bg-main);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  user-select: none;
  transition: background 0.3s;
}
.device {
  width: 375px;
  height: 780px;
  background: var(--bg-main);
  border-radius: 40px;
  position: relative;
  box-shadow: 0 0 0 8px var(--border), 0 0 20px rgba(0,0,0,.5);
  overflow: hidden;
}
.screen {
  width: 100%;
  height: 100%;
  background: var(--bg-surface);
  color: var(--text-main);
  display: flex;
  flex-direction: column;
  transition: background 0.3s, color 0.3s;
}
.status-bar {
  height: 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 25px;
  font-size: 12px;
  font-weight: 600;
  z-index: 100;
}
.app-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  padding: 20px;
  align-content: start;
  flex: 1;
  overflow-y: auto;
}
.app-icon { display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:transform .12s;}
.icon-box { width:60px; height:60px; background: var(--bg-card); border-radius:15px; display:flex; justify-content:center; align-items:center; font-size:28px; margin-bottom:8px; box-shadow:0 2px 5px rgba(0,0,0,.2); border:1px solid var(--border); }
.app-icon span { font-size:11px; text-align:center; color:var(--text-main); }
.page { position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-surface); display:flex; flex-direction:column; transform:translateX(100%); transition:transform .3s cubic-bezier(.2,.8,.2,1); z-index:50; padding-top:55px; }
.page.active { transform:translateX(0); }
.header { position:absolute; top:0; left:0; right:0; height:55px; display:flex; align-items:center; padding:0 15px; background:var(--bg-card); border-bottom:1px solid var(--border); font-weight:bold; font-size:18px; flex-shrink:0; color:var(--text-main); z-index:60; }
.back-btn { background:none; border:none; font-size:26px; color:var(--primary); margin-right:15px; cursor:pointer; padding:0; line-height:1; }
.content { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; }
.card { background:var(--bg-card); border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,.1); border:1px solid var(--border); }
input, textarea, select { width:100%; padding:12px; background:var(--input-bg); border:1px solid var(--border); border-radius:8px; color:var(--text-main); font-family:inherit; margin-bottom:10px; box-sizing:border-box; }
button { padding:10px 12px; border-radius:8px; border:none; font-weight:600; cursor:pointer; background:var(--primary); color:var(--primary-contrast); margin-bottom:10px; transition:background .2s; }
button.small { padding:6px 8px; font-size:13px; width:auto; }
.chat-container { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.chat-list { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
.msg { max-width:80%; padding:10px 15px; border-radius:18px; font-size:14px; line-height:1.4; word-wrap:break-word; }
.msg.me { align-self:flex-end; background:var(--primary); color:var(--text-main); border-bottom-right-radius:4px; }
.msg.other { align-self:flex-start; background:var(--bg-card); color:var(--text-main); border:1px solid var(--border); border-bottom-left-radius:4px; }
.chat-input { padding:10px; background:var(--bg-card); border-top:1px solid var(--border); display:flex; gap:10px; flex-shrink:0; }
.stat-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:14px; }
.modal { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; padding:20px; }
.modal-content { background:var(--bg-surface); padding:20px; border-radius:15px; width:100%; max-width:560px; max-height:80%; overflow-y:auto; border:2px solid var(--primary); }
small { color:var(--text-sub); }
/* utility */
.center { display:flex; justify-content:center; align-items:center; }
.command-msg { background: #3f51b5; color: white; border-radius: 18px; padding: 10px 15px; max-width: 80%; margin: 5px 0; align-self: center; font-size: 13px; }
</style>
</head>
<body onload="init()">

<div class="device">
  <div class="screen">
    <div class="status-bar">
      <span id="clock">10:00</span>
      <span><span id="battery">100%</span> üîã</span>
    </div>

    <div id="home" class="content" style="padding-top:40px;">
      <h1 style="margin:0 0 20px 20px; font-family:'Brush Script MT', cursive; color:var(--primary);">Mestre OS</h1>
      <div class="app-grid">
        <div class="app-icon" onclick="go('profile')"><div class="icon-box" style="color:#2196f3">üë§</div><span>Perfil</span></div>
        <div class="app-icon" onclick="go('feed')"><div class="icon-box" style="color:#e91e63">üì∞</div><span>Feed</span></div>
        <div class="app-icon" onclick="go('chats')"><div class="icon-box" style="color:#4caf50">üí¨</div><span>Chats</span></div>
        <div class="app-icon" onclick="go('sessions')"><div class="icon-box" style="color:#9c27b0">üé≤</div><span>Sess√µes</span></div>
        <div class="app-icon" onclick="go('sheet')"><div class="icon-box" style="color:#ff9800">üìú</div><span>Ficha</span></div>
        <div class="app-icon" onclick="go('bank')"><div class="icon-box" style="color:#ffeb3b">üè¶</div><span>Banco</span></div>
        <div class="app-icon" onclick="go('store')"><div class="icon-box" style="color:#795548">üõí</div><span>Loja</span></div>
        <div class="app-icon" onclick="go('notes')"><div class="icon-box" style="color:#607d8b">üìù</div><span>Notas</span></div>
        <div class="app-icon" onclick="go('settings')"><div class="icon-box" style="color:var(--text-sub)">‚öôÔ∏è</div><span>Ajustes</span></div>
      </div>
    </div>

    <div id="profile" class="page">
      <div class="header"><button class="back-btn" onclick="back('profile')">‚Äπ</button> Perfil</div>
      <div class="content">
        <div id="view-login">
          <div class="card">
            <h3>Acesso</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="actionLogin()">Entrar</button>
            <button onclick="actionRegister()" style="background:var(--bg-card); border:1px solid var(--border); color:var(--text-main)">Criar Conta</button>
          </div>
        </div>
        <div id="view-user" style="display:none">
          <div class="card" style="text-align:center">
            <img id="u-pic" src="" style="width:80px; height:80px; border-radius:50%; background:var(--border); object-fit:cover; margin:0 auto 10px; display:none;">
            <h3 id="u-name" style="color:var(--primary)">Nome</h3>
            <p id="u-bio" style="font-size:12px; color:var(--text-sub);">Descri√ß√£o</p>
            <button onclick="showModal('profile-edit-modal', true)">Editar Perfil</button>
          </div>
          <div class="card">
            <h4>Minhas Postagens</h4>
            <div id="profile-feed-list">Nenhuma postagem ainda.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="profile-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'profile-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Editar Dados</h4>
        <input type="text" id="u-name-edit" placeholder="Nome de Usu√°rio">
        <input type="text" id="u-key-edit" placeholder="Chave de Transa√ß√£o (Edit√°vel)">
        <input type="text" id="u-color-edit" placeholder="Cor Hex do Nome (Ex: #FF0000)">
        <input type="text" id="u-img-edit" placeholder="Link da Imagem de Perfil (URL)">
        <textarea id="u-bio-edit" placeholder="Descri√ß√£o/Bio"></textarea>
        <button onclick="saveProfile()" style="background:var(--success)">Salvar Altera√ß√µes</button>
        <button onclick="showModal('profile-edit-modal', false)" style="background:var(--danger)">Cancelar</button>
        <button onclick="actionLogout()" style="background:var(--text-sub); margin-top:10px;">Sair da Conta</button>
      </div>
    </div>

    <div id="feed" class="page">
      <div class="header"><button class="back-btn" onclick="back('feed')">‚Äπ</button> Feed Global</div>
      <div id="feed-list" class="content"></div>
      <button onclick="showModal('post-modal', true)" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; font-size:24px; padding:0;">+</button>
    </div>

    <div id="post-modal" class="modal" onclick="modalBackgroundClick(event, 'post-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Criar Nova Postagem</h4>
        <textarea id="post-txt" rows="5" placeholder="No que est√° pensando?" style="resize:none;"></textarea>
        <input id="post-img" type="text" placeholder="Link da imagem (Opcional)">
        <button onclick="addPost()">Publicar</button>
        <button onclick="showModal('post-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="chats" class="page">
      <div class="header"><button class="back-btn" onclick="back('chats')">‚Äπ</button> Mensagens</div>
      <div class="content">
        <div class="card" onclick="openChat('global')" style="cursor:pointer; display:flex; align-items:center; gap:15px; border-left:4px solid #4caf50;">
          <div style="width:40px; height:40px; background:#4caf50; border-radius:50%; display:flex; justify-content:center; align-items:center;">üåç</div>
          <div><b>Chat Global</b><br><small>P√∫blico para todos</small></div>
        </div>
        <div class="card" onclick="openPrivateSetup()" style="cursor:pointer; display:flex; align-items:center; gap:15px; border-left:4px solid #2196f3;">
          <div style="width:40px; height:40px; background:#2196f3; border-radius:50%; display:flex; justify-content:center; align-items:center;">üîí</div>
          <div><b>Chat Privado</b><br><small>Mensagens diretas por Chave</small></div>
        </div>
        <div class="card" onclick="alert('Entre em uma sess√£o para acessar o Chat da Mesa.')" style="cursor:pointer; display:flex; align-items:center; gap:15px; border-left:4px solid #9c27b0;">
          <div style="width:40px; height:40px; background:#9c27b0; border-radius:50%; display:flex; justify-content:center; align-items:center;">üé≤</div>
          <div><b>Chat da Mesa</b><br><small>Acess√≠vel na Sess√£o</small></div>
        </div>
      </div>
    </div>

    <div id="chat-private-setup" class="modal" onclick="modalBackgroundClick(event, 'chat-private-setup')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Iniciar Chat Privado</h4>
        <input type="text" id="dm-key" placeholder="Chave do Destinat√°rio">
        <button onclick="openPrivateChat()">Abrir Chat</button>
        <button onclick="showModal('chat-private-setup', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="chat-view" class="page">
      <div class="header"><button class="back-btn" onclick="back('chat-view')">‚Äπ</button> <span id="chat-title">Chat</span></div>
      <div class="chat-container">
        <div id="chat-msgs" class="chat-list"></div>
        <div class="chat-input">
          <input id="chat-msg-in" type="text" placeholder="Digite /roll 1d20+5 ou /sheet..." style="margin:0" onkeyup="if(event.key === 'Enter') sendChat()">
          <button onclick="sendChat()" style="width:50px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sessions" class="page">
      <div class="header"><button class="back-btn" onclick="back('sessions')">‚Äπ</button> Sess√µes RPG</div>
      <div class="content">
        <div class="card">
          <h4>Criar Nova Mesa</h4>
          <input id="table-name" type="text" placeholder="Nome da Aventura">
          <select id="table-type">
            <option value="HUMAN">Mestre Humano (Player)</option>
            <option value="AI">Mestre IA (Autom√°tico)</option>
          </select>
          <button onclick="createTable()">Iniciar Campanha</button>
        </div>
        <h4>Mesas Dispon√≠veis</h4>
        <div id="table-list"></div>
      </div>
    </div>

    <div id="active-session" class="page">
      <div class="header">
        <button class="back-btn" onclick="exitTable()">‚Äπ</button>
        <span id="session-name" style="font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Mesa</span>
        <button onclick="toggleGmTools()" id="gm-btn" style="width:auto; background:none; color:var(--primary); display:none; margin:0 0 0 auto; padding:0;">üõ†Ô∏è</button>
      </div>
      <div class="chat-container">
        <div id="gm-panel" style="display:none; background:var(--bg-card); padding:10px; border-bottom:1px solid var(--border); flex-shrink:0;">
          <small>Painel do Mestre</small>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <select id="gm-target" style="margin:0; flex:1;"></select>
            <input id="gm-val" type="text" placeholder="Valor/Item" style="margin:0; flex:1;">
          </div>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button onclick="gmCmd('hp')" style="margin:0; font-size:12px;">Alterar HP</button>
            <button onclick="gmCmd('xp')" style="margin:0; font-size:12px;">Dar XP</button>
            <button onclick="gmCmd('item')" style="margin:0; font-size:12px;">Dar Item</button>
          </div>
        </div>
        <div id="session-log" class="chat-list"></div>
        <div class="chat-input">
          <input id="session-in" type="text" placeholder="A√ß√£o, fala ou /roll 1d20..." style="margin:0" onkeyup="if(event.key === 'Enter') sendSession()">
          <button onclick="sendSession()" style="width:50px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sheet" class="page">
      <div class="header"><button class="back-btn" onclick="back('sheet')">‚Äπ</button> Ficha do Personagem</div>
      <div class="content">
        <div class="card" style="text-align:center;">
          <img id="char-pic" src="" style="width:100px; height:100px; border-radius:50%; background:#333; object-fit:cover; margin-bottom:10px; display:none;">
          <h3 id="sheet-name-display">Nome</h3>
          <p id="sheet-bio-display" style="font-size:12px; color:var(--text-sub)"></p>
        </div>
        <div class="card">
          <h4>Atributos</h4>
          <div id="sheet-attr-display"></div>
        </div>
        <div class="card">
          <h4>Invent√°rio</h4>
          <div id="sheet-inv-display" style="white-space:pre-wrap;"></div>
        </div>
        <button onclick="showModal('sheet-edit-modal', true)">Editar Ficha</button>
      </div>
    </div>

    <div id="sheet-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'sheet-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Editar Ficha</h4>
        <input id="c-name" type="text" placeholder="Nome do Personagem">
        <input id="c-img" type="text" placeholder="URL da Imagem">
        <textarea id="c-bio" placeholder="Biografia" rows="3"></textarea>
        <input id="c-str" type="number" placeholder="For√ßa">
        <input id="c-dex" type="number" placeholder="Destreza">
        <input id="c-con" type="number" placeholder="Constitui√ß√£o">
        <input id="c-int" type="number" placeholder="Intelig√™ncia">
        <textarea id="c-inv" rows="5" placeholder="Invent√°rio (Um item por linha)"></textarea>
        <button onclick="saveSheet()" style="background:var(--success)">Salvar</button>
        <button onclick="showModal('sheet-edit-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="bank" class="page">
      <div class="header"><button class="back-btn" onclick="back('bank')">‚Äπ</button> Banco</div>
      <div class="content">
        <div class="card" style="background: linear-gradient(45deg, #FFD700, #B8860B); color:black; font-weight:bold;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Saldo Ouro</span>
            <span id="gold-val" style="font-size:24px;">0</span>
          </div>
        </div>
        <div class="card">
          <h4>Carteira (Todos os Saldo)</h4>
          <div id="wallet-div"></div>
        </div>
        <div class="card">
          <h4>Transferir</h4>
          <input id="pay-key" type="text" placeholder="Chave do Jogador Destino">
          <select id="pay-type">
            <option value="ouro">Ouro</option>
            <option value="prata">Prata</option>
            <option value="cobre">Cobre</option>
            <option value="bronze">Bronze</option>
            <option value="diamante">Diamante</option>
            <option value="esmeralda">Esmeralda</option>
          </select>
          <input id="pay-amt" type="number" placeholder="Quantidade">
          <button onclick="transfer()">Enviar</button>
        </div>
      </div>
    </div>

    <div id="store" class="page">
      <div class="header"><button class="back-btn" onclick="back('store')">‚Äπ</button> Loja</div>
      <div class="content">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <button onclick="switchStore('sys')" id="btn-sys" style="flex:1;">Sistema</button>
          <button onclick="switchStore('usr')" id="btn-usr" style="flex:1; background:var(--bg-card); color:var(--text-main);">Jogadores</button>
        </div>
        <div id="store-sys">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>‚öîÔ∏è Espada Longa</span>
              <button onclick="buySys('Espada Longa', 50)" style="width:auto; margin:0; padding:5px 10px;">50 Ouro</button>
            </div>
          </div>
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>üõ°Ô∏è Escudo de Ferro</span>
              <button onclick="buySys('Escudo', 30)" style="width:auto; margin:0; padding:5px 10px;">30 Ouro</button>
            </div>
          </div>
        </div>
        <div id="store-usr" style="display:none;">
          <div class="card">
            <small>Vender Item do Invent√°rio</small>
            <select id="sell-item-select"></select>
            <input id="sell-price" type="number" placeholder="Pre√ßo">
            <select id="sell-curr"><option value="ouro">Ouro</option><option value="diamante">Diamante</option></select>
            <button onclick="postSell()">Anunciar</button>
          </div>
          <div id="market-list"></div>
        </div>
      </div>
    </div>

    <div id="notes" class="page">
      <div class="header"><button class="back-btn" onclick="back('notes')">‚Äπ</button> Bloco de Notas</div>
      <div class="content">
        <textarea id="note-pad" style="flex:1; resize:none;" placeholder="Suas anota√ß√µes..."></textarea>
        <button onclick="saveNote()" style="background:var(--success)">Salvar Notas</button>
      </div>
    </div>

    <div id="settings" class="page">
      <div class="header"><button class="back-btn" onclick="back('settings')">‚Äπ</button> Ajustes</div>
      <div class="content">
        <div class="card">
          <h4>Tema do Sistema</h4>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="setMode('dark')" style="flex:1; background:var(--bg-main);">Escuro</button>
            <button onclick="setMode('light')" style="flex:1; background:#eee; color:#000;">Claro</button>
          </div>
          <h4>Cor de Destaque</h4>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
            <button onclick="setAccent('#6200ea')" style="background:#6200ea; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#d50000')" style="background:#d50000; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#00c853')" style="background:#00c853; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#2962ff')" style="background:#2962ff; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#ffab00')" style="background:#ffab00; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#800080')" style="background:#800080; width:30px; height:30px; padding:0;"></button>
            <button onclick="setAccent('#ff4081')" style="background:#ff4081; width:30px; height:30px; padding:0;"></button>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="color-picker" type="color" value="#6200ea" style="width:48px; height:36px; padding:0; border-radius:6px; border:1px solid var(--border);">
            <button class="small" onclick="setAccent(document.getElementById('color-picker').value)">Aplicar Cor</button>
            <button class="small" onclick="resetAccent()">Resetar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ------------------
   CONFIGURA√á√ïES FIREBASE
   ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBykDF5TNKQHejUJTp-ue7s5CKfpJp1HV0",
  authDomain: "mestre-471a0.firebaseapp.com",
  databaseURL: "https://mestre-471a0-default-rtdb.firebaseio.com",
  projectId: "mestre-471a0",
  storageBucket: "mestre-471a0.appspot.com",
  messagingSenderId: "142996111628",
  appId: "1:142996111628:web:c3785e54588632f468c929"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* Chave IA: se for teste local ok ‚Äî em produ√ß√£o mova para backend */
const AI_KEY = "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";

let user = null;
let activeChat = null;
let activeTable = null;

/* ------------------ HELPERS ------------------ */
function showModal(id, show) {
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = show ? 'flex' : 'none';
}
function modalBackgroundClick(e, id) {
  if(e.target && e.target.id === id) {
    showModal(id, false);
  }
}

/* Color utils */
function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  const bigint = parseInt(hex,16);
  return {r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255};
}
function rgbToHex(r,g,b){
  return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}
function shade(hex, percent){
  const c = hexToRgb(hex);
  const t = percent < 0 ? 0 : 255;
  const p = Math.abs(percent);
  const R = Math.round((t - c.r)*p) + c.r;
  const G = Math.round((t - c.g)*p) + c.g;
  const B = Math.round((t - c.b)*p) + c.b;
  return rgbToHex(R,G,B);
}
function getContrastColor(hex){
  const c = hexToRgb(hex);
  const yiq = ((c.r*299)+(c.g*587)+(c.b*114))/1000;
  return (yiq >= 128) ? '#000000' : '#ffffff';
}

function escapeHtml(unsafe) {
  return (unsafe || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ------------------
   INICIALIZA√á√ÉO
   ------------------ */
function init() {
  // rel√≥gio
  setInterval(()=>{
    const d = new Date();
    document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }, 1000);

  // Bateria (se suportado)
  if (navigator.getBattery) {
    navigator.getBattery().then(b => {
      document.getElementById('battery').innerText = Math.round(b.level*100)+'%';
    }).catch(()=>{});
  }

  auth.onAuthStateChanged(u=>{
    user = u;
    if(u) {
      document.getElementById('view-login').style.display = 'none';
      document.getElementById('view-user').style.display = 'block';
      loadUser();
    } else {
      document.getElementById('view-login').style.display = 'block';
      document.getElementById('view-user').style.display = 'none';
    }
  });

  // load initial data
  loadFeed();
  loadTables();

  // apply initial accent from color-picker
  const cp = document.getElementById('color-picker');
  if(cp) setAccent(cp.value);
}

/* ------------------
   AUTENTICA√á√ÉO
   ------------------ */
async function actionLogin(){
  try{
    await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
  } catch(e){ alert(e.message); }
}
async function actionRegister(){
  try{
    await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
    const uid = auth.currentUser.uid;
    const defaultName = uid.substring(0,6);
    db.ref('users/'+uid).set({
      name: defaultName,
      key: defaultName.toUpperCase(),
      color: '#ffffff',
      bio: 'Novo aventureiro!',
      wallet: {ouro:100, prata:50, cobre:20, bronze:0, diamante:0, esmeralda:0},
      char: {name:'Her√≥i', img:'', bio:'', inv:'Po√ß√£o de Cura\nEspada Curta', str:10, dex:10, con:10, int:10, hp: 10, maxHp: 10}
    });
  } catch(e){ alert(e.message); }
}
function actionLogout(){ auth.signOut(); }

/* ------------------
   USU√ÅRIO / PERFIL
   ------------------ */
function loadUser(){
  if(!user) return;
  db.ref('users/'+user.uid).on('value', s=>{
    const d = s.val() || {};
    const defaultName = user.uid.substring(0,6);
    const uName = d.name || defaultName;

    document.getElementById('u-name').innerText = uName;
    document.getElementById('u-name').style.color = d.color || 'var(--primary)';
    document.getElementById('u-bio').innerText = d.bio || 'Sem descri√ß√£o.';
    if(d.img) {
      document.getElementById('u-pic').src = d.img;
      document.getElementById('u-pic').style.display = 'block';
    } else {
      document.getElementById('u-pic').style.display = 'none';
    }

    document.getElementById('note-pad').value = d.note || '';

    document.getElementById('u-name-edit').value = uName;
    document.getElementById('u-key-edit').value = d.key || defaultName.toUpperCase();
    document.getElementById('u-color-edit').value = d.color || '#ffffff';
    document.getElementById('u-img-edit').value = d.img || '';
    document.getElementById('u-bio-edit').value = d.bio || '';

    if(d.wallet) {
      document.getElementById('gold-val').innerText = d.wallet.ouro || 0;
      let h = '';
      for(let k in d.wallet) h += `<div class="stat-row"><span>${k.toUpperCase()}</span><span>${d.wallet[k]}</span></div>`;
      document.getElementById('wallet-div').innerHTML = h;
    }

    if(d.char) {
      document.getElementById('sheet-name-display').innerText = d.char.name || 'Sem Nome';
      document.getElementById('sheet-bio-display').innerText = d.char.bio || '';
      document.getElementById('sheet-attr-display').innerHTML = `
        <div class="stat-row"><span>HP</span><span>${d.char.hp || 0} / ${d.char.maxHp || 0}</span></div>
        <div class="stat-row"><span>For√ßa</span><span>${d.char.str || 0}</span></div>
        <div class="stat-row"><span>Destreza</span><span>${d.char.dex || 0}</span></div>
        <div class="stat-row"><span>Constitui√ß√£o</span><span>${d.char.con || 0}</span></div>
        <div class="stat-row"><span>Intelig√™ncia</span><span>${d.char.int || 0}</span></div>
      `;
      document.getElementById('sheet-inv-display').innerText = d.char.inv || 'Invent√°rio Vazio';

      document.getElementById('c-name').value = d.char.name || '';
      document.getElementById('c-img').value = d.char.img || '';
      document.getElementById('c-bio').value = d.char.bio || '';
      document.getElementById('c-inv').value = d.char.inv || '';
      document.getElementById('c-str').value = d.char.str || '';
      document.getElementById('c-dex').value = d.char.dex || '';
      document.getElementById('c-con').value = d.char.con || '';
      document.getElementById('c-int').value = d.char.int || '';

      const invItems = (d.char.inv || '').split('\n').filter(i => i.trim() !== '');
      const sel = document.getElementById('sell-item-select');
      if(sel) sel.innerHTML = invItems.map(item => `<option value="${item}">${item}</option>`).join('');
      if (invItems.length === 0 && sel) sel.innerHTML = '<option value="">Invent√°rio Vazio</option>';

      if(d.char.img) {
        document.getElementById('char-pic').src = d.char.img;
        document.getElementById('char-pic').style.display = 'block';
      }
    }
    loadProfileFeed();
  });
}

function saveProfile(){
  const data = {
    name: document.getElementById('u-name-edit').value,
    key: document.getElementById('u-key-edit').value.toUpperCase(),
    color: document.getElementById('u-color-edit').value,
    img: document.getElementById('u-img-edit').value,
    bio: document.getElementById('u-bio-edit').value
  };
  if(!user) return alert('Fa√ßa login.');
  db.ref('users/'+user.uid).update(data);
  showModal('profile-edit-modal', false);
}

function saveSheet(){
  const data = {
    name: document.getElementById('c-name').value,
    img: document.getElementById('c-img').value,
    bio: document.getElementById('c-bio').value,
    inv: document.getElementById('c-inv').value,
    str: Number(document.getElementById('c-str').value) || 0,
    dex: Number(document.getElementById('c-dex').value) || 0,
    con: Number(document.getElementById('c-con').value) || 0,
    int: Number(document.getElementById('c-int').value) || 0
  };
  if(!user) return alert('Fa√ßa login.');
  db.ref('users/'+user.uid+'/char').update(data); // Usa update para n√£o resetar HP/MaxHP/XP
  showModal('sheet-edit-modal', false);
}

function saveNote(){
  if(!user) return alert('Fa√ßa login.');
  db.ref('users/'+user.uid+'/note').set(document.getElementById('note-pad').value);
  alert('Notas Salvas');
}

/* ------------------
   FEED
   ------------------ */
function addPost(){
  const t = document.getElementById('post-txt').value;
  const i = document.getElementById('post-img').value;
  if(!t) return alert('Digite algo para postar.');
  if(!user) return alert('Fa√ßa login para postar.');

  const payload = {
    u: document.getElementById('u-name').innerText,
    uid: user.uid,
    txt: t,
    img: i || '',
    ts: firebase.database.ServerValue.TIMESTAMP
  };

  // push and handle result explicitly
  db.ref('feed').push(payload)
    .then(()=> {
      document.getElementById('post-txt').value = '';
      document.getElementById('post-img').value = '';
      showModal('post-modal', false);
      // ensure feed reload (should be realtime but force a quick refresh)
      setTimeout(()=> loadFeed(), 300);
    })
    .catch(err => {
      console.error('Erro ao postar', err);
      alert('Erro ao postar: ' + err.message);
    });
}

function renderPost(p){
  const time = p.ts ? new Date(p.ts).toLocaleString() : '';
  return `<div class="card" style="border-left:4px solid ${p.color || 'var(--primary)'};">
    <small style="color:${p.color || 'var(--primary)'}">${p.u} ¬∑ ${time}</small>
    <div style="margin-top:5px">${escapeHtml(p.txt)}</div>
    ${p.img ? `<img src="${p.img}" style="width:100%; border-radius:8px; margin-top:10px">` : ''}
  </div>`;
}

function loadFeed(){
  const feedListElement = document.getElementById('feed-list');
  if(!feedListElement) return;
  db.ref('feed').limitToLast(200).on('value', async snapshot=>{
    feedListElement.innerHTML = '';
    const posts = [];
    snapshot.forEach(child => {
      const v = child.val();
      v._id = child.key;
      posts.push(v);
    });
    posts.sort((a,b)=> (b.ts||0)-(a.ts||0)); // newest first
    const uidCache = {};
    for(const post of posts){
      let userName = post.u || 'An√¥nimo';
      let userColor = 'var(--primary)';
      try {
        if(post.uid && !uidCache[post.uid]){
          const userSnapshot = await db.ref('users/' + post.uid).once('value');
          uidCache[post.uid] = userSnapshot.val() || {};
        }
        const ud = uidCache[post.uid];
        if(ud){
          userName = ud.name || userName;
          userColor = ud.color || userColor;
        }
      } catch(e) { console.warn('Erro ao obter usu√°rio do post', e); }
      const fullPost = {...post, u: userName, color: userColor};
      feedListElement.innerHTML += renderPost(fullPost);
    }
    if(posts.length === 0) feedListElement.innerHTML = 'Nenhuma postagem ainda.';
  }, err => {
    console.error('Erro loadFeed', err);
    feedListElement.innerHTML = 'Erro ao carregar feed.';
  });
}

function loadProfileFeed(){
  const profileFeedListElement = document.getElementById('profile-feed-list');
  if(!profileFeedListElement) return;
  if(!user || !user.uid){
    profileFeedListElement.innerHTML = 'Fa√ßa login para ver suas postagens.';
    return;
  }
  db.ref('feed').orderByChild('uid').equalTo(user.uid).limitToLast(50).on('value', async snapshot=>{
    profileFeedListElement.innerHTML = '';
    const posts = [];
    snapshot.forEach(c => {
      const v = c.val();
      v._id = c.key;
      posts.push(v);
    });
    posts.sort((a,b)=> (b.ts||0)-(a.ts||0));
    for(const post of posts){
      profileFeedListElement.innerHTML += renderPost(post);
    }
    if(posts.length === 0) profileFeedListElement.innerHTML = 'Nenhuma postagem ainda.';
  });
}

/* ------------------
   CHATS (GLOBAL / DMS)
   ------------------ */
function openChat(id, recipientKey = null){
  activeChat = id;
  let dbPath = 'chats/'+id;
  if(id === 'private' && recipientKey){
    const userKey = (document.getElementById('u-key-edit').value || '').toUpperCase();
    const sortedKeys = [userKey, recipientKey].sort();
    dbPath = 'dms/'+sortedKeys[0]+'_'+sortedKeys[1] + '/messages';
    document.getElementById('chat-title').innerText = 'DM: ' + recipientKey;
  } else if(id === 'global'){
    document.getElementById('chat-title').innerText = 'Global';
    dbPath = 'chats/global';
  } else {
    document.getElementById('chat-title').innerText = 'Chat';
  }

  go('chat-view');
  const chatRef = db.ref(dbPath).limitToLast(200);
  document.getElementById('chat-msgs').innerHTML = '';
  chatRef.off();
  chatRef.on('child_added', s=>{
    const m = s.val();
    const me = m.uid === (user && user.uid);
    const msgClass = m.isCommand ? 'command-msg' : (me?'me':'other');
    const sender = m.u || 'Sistema';
    const content = m.isCommand ? escapeHtml(m.txt) : `<b>${escapeHtml(sender)}</b><br>${escapeHtml(m.txt)}`;
    document.getElementById('chat-msgs').innerHTML += `<div class="msg ${msgClass}">${content}</div>`;
    const list = document.getElementById('chat-msgs');
    list.scrollTop = list.scrollHeight;
  });
}

function openPrivateSetup(){ showModal('chat-private-setup', true); }

async function openPrivateChat(){
  const recipientKey = (document.getElementById('dm-key').value || '').toUpperCase();
  if(!recipientKey) return alert('Insira a Chave do Destinat√°rio');
  const myKey = (document.getElementById('u-key-edit').value || '').toUpperCase();
  if(recipientKey === myKey) return alert('Voc√™ n√£o pode conversar consigo mesmo!');
  const recipientSnap = await db.ref('users').orderByChild('key').equalTo(recipientKey).once('value');
  if(!recipientSnap.exists()) return alert('Chave de destinat√°rio inv√°lida.');
  const recipientObj = recipientSnap.val();
  const recipientUid = Object.keys(recipientObj)[0];

  const sortedKeys = [myKey, recipientKey].sort();
  const dmId = sortedKeys[0] + '_' + sortedKeys[1];

  const participantsRef = db.ref('dms/' + dmId + '/participants');
  participantsRef.update({ [user.uid]: true, [recipientUid]: true });

  openChat('private', recipientKey);
  showModal('chat-private-setup', false);
}

async function sendChat(){
  const t = document.getElementById('chat-msg-in').value.trim();
  if(!t) return;
  if(!user) return alert('Fa√ßa login para enviar mensagens.');

  document.getElementById('chat-msg-in').value = '';
  
  if(t.startsWith('/')) {
    const commandResult = await handleCommand(t, 'chat');
    if(commandResult) {
      const messageData = {
        u: commandResult.u,
        uid: user.uid,
        txt: commandResult.txt,
        ts: firebase.database.ServerValue.TIMESTAMP,
        isCommand: true // Marca como mensagem de comando
      };
      
      let dbPath = 'chats/'+activeChat;
      if(activeChat === 'private'){
        const recipientKey = document.getElementById('chat-title').innerText.replace('DM: ','');
        const myKey = (document.getElementById('u-key-edit').value || '').toUpperCase();
        const sortedKeys = [myKey, recipientKey].sort();
        dbPath = 'dms/'+sortedKeys[0]+'_'+sortedKeys[1] + '/messages';
      } else {
        dbPath = 'chats/' + (activeChat || 'global');
      }
      
      db.ref(dbPath).push(messageData);
    }
    return; // N√£o envia o comando puro como mensagem
  }

  let dbPath = 'chats/'+activeChat;
  if(activeChat === 'private'){
    const recipientKey = document.getElementById('chat-title').innerText.replace('DM: ','');
    const myKey = (document.getElementById('u-key-edit').value || '').toUpperCase();
    const sortedKeys = [myKey, recipientKey].sort();
    dbPath = 'dms/'+sortedKeys[0]+'_'+sortedKeys[1] + '/messages';
  } else {
    dbPath = 'chats/' + (activeChat || 'global');
  }
  db.ref(dbPath).push({u:document.getElementById('u-name').innerText, uid:user.uid, txt:t, ts: firebase.database.ServerValue.TIMESTAMP});
}

/* ------------------
   COMANDOS DE CHAT (NOVOS)
   ------------------ */
async function handleCommand(text, context = 'session') {
  if (!user) { alert('Voc√™ precisa estar logado para usar comandos.'); return null; }
  const parts = text.split(' ');
  const command = parts[0].toLowerCase();
  const args = parts.slice(1).join(' ');
  const userName = document.getElementById('u-name').innerText;
  
  // ROLAGEM DE DADOS: /roll, /r
  if (command === '/roll' || command === '/r') {
    const rollPattern = /^(\d+)?d(\d+)([\+\-]\d+)?$/i;
    if (!rollPattern.test(args)) return { u: userName, txt: `COMANDO: ${command} Inv√°lido. Use: /roll 1d20+5 ou /r 2d6.` };

    let match = args.match(rollPattern);
    let numDice = parseInt(match[1] || '1');
    let dieSize = parseInt(match[2]);
    let modifier = parseInt(match[3] || '0');
    
    if (numDice > 20 || dieSize > 1000) return { u: userName, txt: `COMANDO: ${command} Falhou. Limite de 20 dados ou d1000.` };

    let total = modifier;
    let rolls = [];
    for (let i = 0; i < numDice; i++) {
      let roll = Math.floor(Math.random() * dieSize) + 1;
      rolls.push(roll);
      total += roll;
    }
    
    let rollDetails = rolls.join(' + ');
    if (modifier !== 0) rollDetails += (modifier > 0 ? ` + ${modifier}` : ` - ${Math.abs(modifier)}`);
    
    return { 
      u: userName, 
      txt: `üé≤ **ROLAGEM**: ${userName} rolou ${args.toUpperCase()}. Resultado: **${total}**\nDetalhes: (${rollDetails})`
    };
  }
  
  if (context === 'session' || context === 'chat') {
    const userSnapshot = await db.ref('users/' + user.uid).once('value');
    const userData = userSnapshot.val();
    const char = userData.char || {};
    const inventory = char.inv ? char.inv.split('\n').map(i => i.trim()).filter(i => i !== '') : [];

    // FICHA: /sheet, /ficha
    if (command === '/sheet' || command === '/ficha') {
      return {
        u: userName,
        txt: `üìú **FICHA DE ${char.name || 'Her√≥i'}**\n- HP: ${char.hp || 0} / ${char.maxHp || 0}\n- FOR: ${char.str || 0}\n- DES: ${char.dex || 0}\n- CON: ${char.con || 0}\n- INT: ${char.int || 0}\n\n*Use /inv para o invent√°rio.*`
      };
    }
    
    // INVENT√ÅRIO: /inv, /inventario
    if (command === '/inv' || command === '/inventario') {
      const invList = inventory.length > 0 ? inventory.map(i => `- ${i}`).join('\n') : 'Vazio';
      return {
        u: userName,
        txt: `üéí **INVENT√ÅRIO DE ${char.name || 'Her√≥i'}**\n${invList}\n\n*Use /use [item] para usar um item.*`
      };
    }
    
    // USAR ITEM: /use
    if (command === '/use') {
      if (!args) return { u: userName, txt: `COMANDO: /use Inv√°lido. Use: /use [nome do item].` };
      
      const itemToUse = args.trim();
      const itemIndex = inventory.findIndex(i => i.toLowerCase() === itemToUse.toLowerCase());

      if (itemIndex > -1) {
        // Remove o item do invent√°rio
        inventory.splice(itemIndex, 1);
        db.ref('users/' + user.uid + '/char/inv').set(inventory.join('\n'));
        
        // Exibe a mensagem de uso
        return {
          u: userName,
          txt: `‚ú® **USO DE ITEM**: ${userName} usou **${itemToUse}**. (Item removido do invent√°rio)`
        };
      } else {
        return { u: userName, txt: `COMANDO: /use Falhou. **${itemToUse}** n√£o encontrado no invent√°rio.` };
      }
    }
  }

  // COMANDO N√ÉO RECONHECIDO
  return { u: userName, txt: `COMANDO: ${command} n√£o reconhecido.` };
}

/* ------------------
   LOJA / MARKET
   ------------------ */
function loadMarket(){
  const d = document.getElementById('market-list');
  if(!d) return;
  db.ref('market').off();
  db.ref('market').on('value', s=>{
    d.innerHTML = '';
    s.forEach(x => {
      const i = x.val();
      if(i.s !== user.uid) d.innerHTML += `<div class="card"><div style="display:flex; justify-content:space-between;"><span>${escapeHtml(i.i)}</span><button onclick="buyUsr('${x.key}', '${i.i}')" style="width:auto; margin:0; padding:5px;">${i.p} ${i.c}</button></div><small>Vendedor: ${escapeHtml(i.u)}</small></div>`;
    });
  });
}

function buySys(i, p){
  db.ref('users/'+user.uid+'/wallet/ouro').once('value', s=>{
    if((s.val()||0) >= p) {
      db.ref('users/'+user.uid+'/wallet/ouro').set(s.val()-p);
      db.ref('users/'+user.uid+'/char/inv').transaction(current => (current || '') + '\n' + i);
      alert('Comprado!');
    } else alert('Sem ouro');
  });
}

function postSell(){
  const item = document.getElementById('sell-item-select').value;
  const price = Number(document.getElementById('sell-price').value);
  const curr = document.getElementById('sell-curr').value;
  if(!item || !price) return alert('Selecione um item e um pre√ßo.');
  db.ref('users/'+user.uid+'/char/inv').once('value', s=>{
    let inventory = (s.val() || '').split('\n').filter(i => i.trim() !== '');
    const itemIndex = inventory.findIndex(i => i.trim() === item.trim());
    if (itemIndex === -1) return alert('Item n√£o encontrado no invent√°rio.');
    inventory.splice(itemIndex, 1);
    db.ref('users/'+user.uid+'/char/inv').set(inventory.join('\n'));
    db.ref('market').push({
      s: user.uid,
      u: document.getElementById('u-name').innerText,
      i: item,
      p: price,
      c: curr
    });
    alert('Item anunciado!');
  });
}

function buyUsr(k, itemName){
  db.ref('market/'+k).once('value', s=>{
    const i = s.val();
    db.ref('users/'+user.uid+'/wallet/'+i.c).once('value', w=>{
      if((w.val()||0) >= i.p) {
        db.ref('users/'+user.uid+'/wallet/'+i.c).set(w.val()-i.p);
        db.ref('users/'+i.s+'/wallet/'+i.c).transaction(v=>(v||0)+i.p);
        db.ref('market/'+k).remove();
        db.ref('users/'+user.uid+'/char/inv').transaction(current => (current || '') + '\n' + itemName);
        alert('Comprado!');
      } else alert('Sem saldo');
    });
  });
}

/* ------------------
   SESS√ïES / MESTRE IA
   ------------------ */

function createTable(){
  const n = document.getElementById('table-name').value;
  const t = document.getElementById('table-type').value;
  if(!n) return alert('Informe nome da aventura.');
  const k = db.ref('tables').push().key;
  db.ref('tables/'+k).set({name:n, type:t, master:user.uid, users:{[user.uid]:document.getElementById('u-name').innerText}, log: []});
  joinTable(k);
}

function loadTables(){
  db.ref('tables').off();
  db.ref('tables').on('value', s=>{
    const d = document.getElementById('table-list');
    d.innerHTML = '';
    s.forEach(x=>{
      const t = x.val();
      d.innerHTML += `<div class="card" onclick="joinTable('${x.key}')" style="cursor:pointer; border-left: 4px solid ${t.type==='AI'?'cyan':'orange'}"><b>${escapeHtml(t.name)}</b><br><small>${t.type === 'AI' ? 'ü§ñ IA' : 'üë§ Humano'}</small></div>`;
    });
  });
}

function joinTable(k){
  activeTable = k;
  db.ref('tables/'+k+'/users/'+user.uid).set(document.getElementById('u-name').innerText);
  go('active-session');
  db.ref('tables/'+k).once('value', s=>{
    const t = s.val();
    document.getElementById('session-name').innerText = t.name;
    const isGm = t.master === user.uid && t.type === 'HUMAN';
    document.getElementById('gm-btn').style.display = isGm ? 'block' : 'none';
    if(isGm) loadGmUsers(k);
  });
  loadSessionLog(k);
}

function exitTable(){
  activeTable = null;
  back('active-session');
  db.ref('tables').off();
}

function toggleGmTools(){
  const p = document.getElementById('gm-panel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

function loadGmUsers(k){
  db.ref('tables/'+k+'/users').on('value', s=>{
    const sel = document.getElementById('gm-target');
    sel.innerHTML = '';
    s.forEach(u => sel.innerHTML += `<option value="${u.key}">${escapeHtml(u.val())}</option>`);
  });
}

function gmCmd(act){
  const u = document.getElementById('gm-target').value;
  const v = document.getElementById('gm-val').value;
  const targetName = document.getElementById('gm-target').options[document.getElementById('gm-target').selectedIndex].text;
  
  if(!u || !v) return alert('Selecione um jogador e informe um valor/item.');

  // Comandos do Mestre (explicitos)
  if (act === 'hp') {
      const amount = parseInt(v);
      if(isNaN(amount)) return alert('Valor de HP inv√°lido.');
      db.ref('users/'+u+'/char/hp').transaction(current => (current || 0) + amount);
      const actionTxt = amount > 0 ? `curou ${amount} de HP` : `causou ${Math.abs(amount)} de dano`;
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre', uid:'sys', txt:`Mestre ${actionTxt} em ${targetName}.`, ts: firebase.database.ServerValue.TIMESTAMP});
  } else if (act === 'xp') {
      const amount = parseInt(v);
      if(isNaN(amount)) return alert('Valor de XP inv√°lido.');
      // O XP n√£o existe no modelo inicial, apenas adicionando log.
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre', uid:'sys', txt:`Mestre deu **${amount} XP** a ${targetName}.`, ts: firebase.database.ServerValue.TIMESTAMP});
  } else if (act === 'item') {
      db.ref('users/'+u+'/char/inv').transaction(current => (current || '') + '\n' + v.trim());
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre', uid:'sys', txt:`Mestre entregou **${v.trim()}** para ${targetName}.`, ts: firebase.database.ServerValue.TIMESTAMP});
  } else {
    db.ref('tables/'+activeTable+'/log').push({u:'Mestre', uid:'sys', txt:`Mestre aplicou ${act.toUpperCase()} ${v} em ${targetName}.`, ts: firebase.database.ServerValue.TIMESTAMP});
  }
}

function loadSessionLog(k){
  const d = document.getElementById('session-log');
  d.innerHTML = '';
  db.ref('tables/'+k+'/log').limitToLast(100).off();
  db.ref('tables/'+k+'/log').limitToLast(100).on('child_added', s=>{
    const m = s.val();
    const me = m.uid === user.uid;
    const msgClass = m.isCommand ? 'command-msg' : (me?'me':'other');
    const sender = m.u || 'Sistema';
    const content = m.isCommand ? escapeHtml(m.txt) : `<b>${escapeHtml(sender)}</b><br>${escapeHtml(m.txt)}`;
    d.innerHTML += `<div class="msg ${msgClass}">${content}</div>`;
    d.scrollTop = d.scrollHeight;
  });
}

/* sendSession: envia a mensagem do jogador e, se for mesa IA, chama a API externa.
   A resposta da IA √© tratada de forma robusta (v√°rios formatos de retorno). 
   CORRIGIDO: O parse da resposta da IA foi simplificado e a chamada foi ajustada.
   ADICIONADO: Tratamento de comandos / no in√≠cio da mensagem.
*/
async function sendSession(){
  const t = document.getElementById('session-in').value.trim();
  if(!t) return;
  if(!activeTable) return alert('Entre em uma mesa.');
  if(!user) return alert('Fa√ßa login antes de enviar (aguarde autentica√ß√£o).');

  document.getElementById('session-in').value = '';
  
  // 1. TRATAMENTO DE COMANDOS DE CHAT
  if(t.startsWith('/')) {
    const commandResult = await handleCommand(t, 'session');
    if(commandResult) {
      const messageData = {
        u: commandResult.u,
        uid: user.uid,
        txt: commandResult.txt,
        ts: firebase.database.ServerValue.TIMESTAMP,
        isCommand: true // Marca como mensagem de comando
      };
      db.ref('tables/'+activeTable+'/log').push(messageData);
    }
    return;
  }

  // 2. MENSAGEM NORMAL DO JOGADOR
  db.ref('tables/'+activeTable+'/log').push({u:document.getElementById('u-name').innerText, uid:user.uid, txt:t, ts: firebase.database.ServerValue.TIMESTAMP});

  // 3. CHAMADA √Ä IA SE FOR MESA IA
  const tableSnap = await db.ref('tables/'+activeTable).get();
  if(tableSnap.exists() && tableSnap.val().type === 'AI'){
    try {
      // 3.1. Obter o hist√≥rico de log recente para contexto (IA √© cega sem isso)
      const logSnap = await db.ref('tables/'+activeTable+'/log').limitToLast(10).once('value');
      const messages = [];
      logSnap.forEach(snap => {
        const m = snap.val();
        if(!m.isCommand) { // Ignora mensagens de comando no contexto da IA
            const role = m.uid === 'ai' ? 'assistant' : 'user';
            const name = m.uid === 'ai' ? 'Mestre_IA' : m.u;
            // Adapta√ß√£o: Se for mensagem do jogador, formata para a IA saber quem falou
            const content = m.uid === 'ai' ? m.txt : `[${name}] diz: ${m.txt}`;
            messages.push({role: role, content: content});
        }
      });
      
      // 3.2. Define o prompt inicial e o sistema (para context-awareness)
      const systemMessage = "Voc√™ √© um Mestre de RPG (Dungeon Master) para uma mesa de fantasia medieval. Seja descritivo, desafiador e mantenha a narrativa. Responda apenas com a perspectiva do Mestre, sem comandos ou introdu√ß√µes desnecess√°rias. Use o hist√≥rico de mensagens para dar contexto. N√£o se refira a si mesmo como 'Mestre IA', apenas como 'o Mestre'.";
      
      // Adiciona o sistema e a √∫ltima mensagem do jogador, se necess√°rio
      const finalMessages = [{role: "system", content: systemMessage}, ...messages];

      const body = {
        model: "mistralai/mistral-7b-instruct",
        messages: finalMessages,
        meta: { uid: user.uid }
      };
      
      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${AI_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      
      if(!response.ok){
        const txt = await response.text();
        console.error('Erro IA', response.status, txt);
        db.ref('tables/'+activeTable+'/log').push({u:'Mestre IA', uid:'ai', txt:`**Erro IA**: Falha na comunica√ß√£o com a API (${response.status}).`, ts: firebase.database.ServerValue.TIMESTAMP});
        return;
      }
      
      const j = await response.json();

      // Parse robusto
      let aiText = "O Mestre n√£o respondeu (erro de parse).";
      if(j && j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content){
        aiText = j.choices[0].message.content.trim();
      } else {
        // Fallback em caso de formato inesperado
        aiText = "O Mestre n√£o respondeu (formato inesperado). " + JSON.stringify(j).slice(0, 100);
      }
      
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre IA', uid:'ai', txt:aiText, ts: firebase.database.ServerValue.TIMESTAMP});
    } catch(e) {
      console.error('Erro ao chamar IA', e);
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre IA', uid:'ai', txt:'**Erro de Conex√£o**: N√£o foi poss√≠vel gerar resposta da IA.', ts: firebase.database.ServerValue.TIMESTAMP});
    }
  }
}

/* ------------------
   TRANSFER√äNCIAS
   ------------------ */
function transfer(){
  const k = (document.getElementById('pay-key').value || '').toUpperCase();
  const c = document.getElementById('pay-type').value;
  const a = Number(document.getElementById('pay-amt').value);
  if(!k || !a) return alert('Preencha chave e valor.');
  db.ref('users/'+user.uid+'/wallet/'+c).once('value', s=>{
    if((s.val()||0) < a) return alert('Saldo insuficiente');
    db.ref('users').orderByChild('key').equalTo(k).once('value', u=>{
      if(!u.exists()) return alert('Chave inv√°lida');
      const dest = Object.keys(u.val())[0];
      db.ref('users/'+user.uid+'/wallet/'+c).set(s.val()-a);
      db.ref('users/'+dest+'/wallet/'+c).transaction(v => (v||0)+a);
      alert('Enviado!');
    });
  });
}

/* ------------------
   OUTROS (market switch etc.)
   ------------------ */
function switchStore(m){
  document.getElementById('store-sys').style.display = m==='sys'?'block':'none';
  document.getElementById('store-usr').style.display = m==='usr'?'block':'none';
  document.getElementById('btn-sys').style.background = m==='sys'?'var(--primary)':'var(--bg-card)';
  document.getElementById('btn-usr').style.background = m==='usr'?'var(--primary)':'var(--bg-card)';
}

/* simples helpers de navega√ß√£o */
function go(id){ document.getElementById(id).classList.add('active'); if(id==='store') loadMarket(); }
function back(id){ document.getElementById(id).classList.remove('active'); }
function setMode(m){ const r = document.documentElement.style; if(m==='light'){ r.setProperty('--bg-main','#ddd'); r.setProperty('--bg-surface','#f5f5f5'); r.setProperty('--bg-card','#ffffff'); r.setProperty('--text-main','#000'); r.setProperty('--border','#ccc'); r.setProperty('--input-bg','#eee'); } else { r.setProperty('--bg-main','#000'); r.setProperty('--bg-surface','#121212'); r.setProperty('--bg-card','#1e1e1e'); r.setProperty('--text-main','#ffffff'); r.setProperty('--border','#333'); r.setProperty('--input-bg','#2c2c2c'); } }
function setAccent(c){
  // set primary and some derived variables to change whole interface feel
  document.documentElement.style.setProperty('--primary', c);
  const contrast = getContrastColor(c);
  document.documentElement.style.setProperty('--primary-contrast', contrast);
  // border slightly darker
  const darker = shade(c, -0.2);
  document.documentElement.style.setProperty('--border', darker);
  // card background tinted slightly
  const card = shade(c, -0.9);
  document.documentElement.style.setProperty('--bg-card', card);
  // input bg slightly darker than card
  document.documentElement.style.setProperty('--input-bg', shade(card, -0.08));
  // update buttons color
  const buttons = document.querySelectorAll('button');
  buttons.forEach(b => {
    if(!b.style.background || b.style.background === '' || b.style.background.startsWith('var(')) {
      b.style.background = c;
      b.style.color = contrast;
    }
  });
}
function resetAccent(){ document.getElementById('color-picker').value = '#6200ea'; setAccent('#6200ea'); }

</script>
</body>
</html>
