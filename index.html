<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Mestre</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
/* --- TEMA E VARI√ÅVEIS --- */
:root {
  --primary: #6200ea;
  --primary-contrast: #ffffff;
  --bg-main: #050505;
  --bg-surface: #121212;
  --bg-card: #1e1e1e;
  --text-main: #e0e0e0;
  --text-sub: #a0a0a0;
  --border: #333333;
  --input-bg: #252525;
  --danger: #cf6679;
  --success: #03dac6;
  --warn: #ffb74d;
}
* { box-sizing: border-box; }
body {
  margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
  background: var(--bg-main);
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  user-select: none; overflow: hidden;
}

/* --- LAYOUT DO DISPOSITIVO --- */
.device {
  width: 100%; max-width: 420px; height: 100%; max-height: 880px;
  background: var(--bg-main); position: relative; 
  display: flex; flex-direction: column; overflow: hidden;
}
@media (min-width: 450px) {
  .device { 
    height: 85vh; border-radius: 30px; 
    box-shadow: 0 0 0 10px #1a1a1a, 0 0 30px rgba(0,0,0,0.8); 
  }
}

/* --- ESTRUTURA --- */
.screen {
  width: 100%; height: 100%; background: var(--bg-surface); color: var(--text-main);
  display: flex; flex-direction: column; position: relative;
}
.header { 
  height: 60px; display: flex; align-items: center; padding: 0 15px; 
  background: var(--bg-card); border-bottom: 1px solid var(--border); 
  font-weight: bold; font-size: 18px; flex-shrink: 0; z-index: 10;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

/* --- P√ÅGINAS (Transi√ß√µes) --- */
.page { 
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
  background: var(--bg-surface); display: flex; flex-direction: column; 
  transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
  z-index: 20; 
}
.page.active { transform: translateX(0); }

/* --- COMPONENTES --- */
.card { 
  background: var(--bg-card); border-radius: 12px; padding: 15px; 
  border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.app-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px;
}
.app-icon { 
  display: flex; flex-direction: column; align-items: center; gap: 5px; 
  cursor: pointer; transition: 0.2s;
}
.app-icon:active { transform: scale(0.9); }
.icon-box { 
  width: 60px; height: 60px; background: var(--bg-card); border-radius: 18px; 
  display: flex; justify-content: center; align-items: center; font-size: 28px;
  border: 1px solid var(--border);
}

/* --- FORMUL√ÅRIOS --- */
input, textarea, select { 
  width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border); 
  border-radius: 8px; color: var(--text-main); margin-bottom: 10px; outline: none; font-size: 14px;
}
input:focus { border-color: var(--primary); }
button { 
  width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; 
  background: var(--primary); color: var(--primary-contrast); cursor: pointer; 
  transition: 0.2s; font-size: 14px;
}
button:active { filter: brightness(0.8); }
.back-btn { width: auto; background: transparent; color: var(--primary); font-size: 24px; padding: 0 15px 0 0; margin: 0; }

/* --- CHAT --- */
.chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.chat-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg { 
  max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; 
  position: relative; word-wrap: break-word;
}
.msg.me { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 2px; }
.msg.other { align-self: flex-start; background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
.msg.system { align-self: center; font-size: 11px; color: var(--text-sub); border: 1px dashed var(--border); background: transparent; width: 100%; text-align: center; }
.msg.narrate { width: 100%; background: #1a237e; border: 1px solid #3949ab; text-align: center; font-style: italic; color: #fff; }

/* --- MODAL --- */
.modal { 
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
  background: rgba(0,0,0,0.85); z-index: 100; display: none; 
  justify-content: center; align-items: center; backdrop-filter: blur(4px);
}
.modal-content { 
  background: var(--bg-surface); width: 90%; max-width: 400px; max-height: 90vh; 
  overflow-y: auto; padding: 20px; border-radius: 16px; border: 1px solid var(--border);
}

/* --- UTILIT√ÅRIOS --- */
.stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.gm-toolbar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
.gm-toolbar button { white-space: nowrap; font-size: 12px; padding: 8px; }
.tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: #333; margin-left: 5px; vertical-align: middle; }

/* --- BARRAS DE VIDA --- */
.hp-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 5px; }
.hp-bar-fill { height: 100%; background: #d32f2f; transition: width 0.3s; }

</style>
</head>
<body onload="init()">

<div class="device">
  
  <div id="home" class="screen" style="padding: 20px;">
    <h2 style="color:var(--primary); text-align: center; margin-bottom: 30px; font-size: 32px;">Mestre<small style="font-size:12px; color:var(--text-sub)">v3.0</small></h2>
    
    <div class="app-grid">
      <div class="app-icon" onclick="go('profile')"><div class="icon-box" style="color:#42a5f5">üë§</div><span>Perfil</span></div>
      <div class="app-icon" onclick="go('sessions')"><div class="icon-box" style="color:#ab47bc">üé≤</div><span>Mesas</span></div>
      <div class="app-icon" onclick="go('chats')"><div class="icon-box" style="color:#66bb6a">üí¨</div><span>Chats</span></div>
      <div class="app-icon" onclick="go('sheet')"><div class="icon-box" style="color:#ffa726">üìú</div><span>Ficha</span></div>
      <div class="app-icon" onclick="go('store')"><div class="icon-box" style="color:#8d6e63">üõí</div><span>Loja</span></div>
      <div class="app-icon" onclick="go('bank')"><div class="icon-box" style="color:#fdd835">üè¶</div><span>Banco</span></div>
      <div class="app-icon" onclick="go('feed')"><div class="icon-box" style="color:#ef5350">üì∞</div><span>Feed</span></div>
      <div class="app-icon" onclick="go('notes')"><div class="icon-box" style="color:#78909c">üìù</div><span>Notas</span></div>
      <div class="app-icon" onclick="go('settings')"><div class="icon-box" style="color:#bdbdbd">‚öôÔ∏è</div><span>Config</span></div>
    </div>
  </div>

  <div id="profile" class="page">
    <div class="header"><button class="back-btn" onclick="back('profile')">‚Äπ</button> Perfil</div>
    <div class="content">
      <div id="view-login">
        <div class="card">
          <h3>Bem-vindo</h3>
          <input type="email" id="login-email" placeholder="E-mail">
          <input type="password" id="login-pass" placeholder="Senha">
          <button onclick="doLogin()">Entrar</button>
          <button onclick="doRegister()" style="background:transparent; border:1px solid var(--border); margin-top:5px;">Criar Conta</button>
        </div>
      </div>
      <div id="view-user" style="display:none">
        <div class="card" style="text-align:center">
          <img id="u-img" src="" style="width:80px;height:80px;border-radius:50%;background:#333;object-fit:cover;margin:0 auto 10px; border: 2px solid var(--primary);">
          <h3 id="u-name" style="margin:5px 0; color:var(--primary)">Usu√°rio</h3>
          <p id="u-key" style="font-family:monospace; background:#000; padding:4px; display:inline-block; border-radius:4px; font-size:12px;">KEY</p>
          <div style="margin-top:10px;">
             <button onclick="openEditProfile()" class="small">Editar Perfil</button>
             <button onclick="auth.signOut()" style="background:var(--danger)">Sair</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-profile" class="modal" onclick="closeModal(event, 'modal-profile')">
    <div class="modal-content">
      <h4>Editar Perfil</h4>
      <input id="edit-name" placeholder="Nome de Exibi√ß√£o">
      <input id="edit-img" placeholder="URL da Imagem">
      <textarea id="edit-bio" placeholder="Biografia curta"></textarea>
      <button onclick="saveProfile()">Salvar</button>
    </div>
  </div>

  <div id="sessions" class="page">
    <div class="header"><button class="back-btn" onclick="back('sessions')">‚Äπ</button> Mesas de RPG</div>
    <div class="content">
      <div class="card">
        <h4>Criar Nova Mesa</h4>
        <input id="new-table-name" placeholder="Nome da Campanha">
        <input id="new-table-pass" type="password" placeholder="Senha da Mesa (Opcional)">
        <button onclick="createTable()">Criar Mesa</button>
      </div>
      <hr style="border:0; border-top:1px solid var(--border); width:100%;">
      <h4>Mesas Dispon√≠veis</h4>
      <div id="tables-list"></div>
    </div>
  </div>

  <div id="modal-table-pass" class="modal" onclick="closeModal(event, 'modal-table-pass')">
    <div class="modal-content">
      <h4>Mesa Privada üîí</h4>
      <p>Esta mesa requer senha para entrar.</p>
      <input id="join-pass" type="password" placeholder="Digite a senha">
      <button onclick="confirmJoinTable()">Entrar</button>
    </div>
  </div>

  <div id="active-session" class="page">
    <div class="header">
      <button class="back-btn" onclick="leaveTable()">‚Äπ</button> 
      <span id="session-title" style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Mesa</span>
      <button id="gm-tools-btn" onclick="toggleGmPanel()" style="width:auto; padding:5px 10px; font-size:12px; display:none;">üëë GM</button>
    </div>
    
    <div class="chat-container">
      <div id="gm-panel" style="display:none; background:var(--bg-card); padding:10px; border-bottom:1px solid var(--primary);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
           <small style="color:var(--primary); font-weight:bold;">FERRAMENTAS DO MESTRE</small>
           <button onclick="toggleGmPanel()" style="width:auto; padding:2px 8px; font-size:10px; background:var(--danger)">X</button>
        </div>
        
        <select id="gm-target-select" style="margin-bottom:5px; background:#000;"></select>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:5px;">
           <input id="gm-val-hp" type="number" placeholder="HP (+/-)">
           <input id="gm-val-xp" type="number" placeholder="XP (+)">
           <input id="gm-val-item" type="text" placeholder="Nome Item">
        </div>
        
        <div class="gm-toolbar">
          <button onclick="gmAction('hp')" style="background:var(--danger)">Mod HP</button>
          <button onclick="gmAction('xp')" style="background:var(--warn); color:#000;">Dar XP</button>
          <button onclick="gmAction('item')" style="background:var(--success); color:#000;">Dar Item</button>
          <button onclick="openGmInspect()" style="background:#42a5f5;">üîç Inspecionar</button>
        </div>
      </div>

      <div id="session-log" class="chat-list"></div>
      
      <div class="chat-input">
        <input id="session-msg" placeholder="Mensagem ou /ajuda..." onkeydown="if(event.key==='Enter') sendSessionMsg()">
        <button onclick="sendSessionMsg()" style="width:50px;">‚û§</button>
      </div>
    </div>
  </div>

  <div id="modal-gm-inspect" class="modal" onclick="closeModal(event, 'modal-gm-inspect')">
    <div class="modal-content">
      <h4>Editor de Personagem (GM)</h4>
      <input type="hidden" id="gm-edit-uid">
      <label><small>Nome do Personagem</small></label>
      <input id="gm-edit-name">
      <div style="display:flex; gap:5px;">
        <div><small>HP Atual</small><input id="gm-edit-hp" type="number"></div>
        <div><small>HP Max</small><input id="gm-edit-maxhp" type="number"></div>
      </div>
      <label><small>Invent√°rio (Texto)</small></label>
      <textarea id="gm-edit-inv" rows="5"></textarea>
      <button onclick="gmSavePlayer()" style="background:var(--success)">Salvar Altera√ß√µes</button>
    </div>
  </div>

  <div id="sheet" class="page">
    <div class="header"><button class="back-btn" onclick="back('sheet')">‚Äπ</button> Ficha</div>
    <div class="content">
      <div class="card">
        <div style="display:flex; gap:15px; align-items:center;">
           <img id="char-img-display" src="" style="width:60px; height:60px; border-radius:10px; background:#333; object-fit:cover;">
           <div style="flex:1;">
             <h3 id="char-name-display" style="margin:0;">Sem Nome</h3>
             <small id="char-lvl-display" style="color:var(--warn)">N√≠vel 1</small>
           </div>
        </div>
        <div style="margin-top:10px;">
          <div style="display:flex; justify-content:space-between; font-size:12px;">
            <span>HP</span>
            <span id="hp-text">10/10</span>
          </div>
          <div class="hp-bar-bg"><div id="hp-bar" class="hp-bar-fill" style="width:100%"></div></div>
        </div>
        <div style="margin-top:10px; display:flex; justify-content:space-between; font-size:12px; color:var(--warn);">
            <span>XP</span>
            <span id="xp-text">0</span>
        </div>
      </div>

      <div class="card">
        <h4>Atributos</h4>
        <div id="attrs-list"></div>
      </div>

      <div class="card">
        <h4>Invent√°rio</h4>
        <pre id="inv-display" style="white-space:pre-wrap; font-family:inherit; color:var(--text-sub); margin:0;">Vazio</pre>
      </div>
      <button onclick="openEditSheet()">Editar Detalhes</button>
    </div>
  </div>

  <div id="modal-sheet-edit" class="modal" onclick="closeModal(event, 'modal-sheet-edit')">
    <div class="modal-content">
      <h4>Editar Ficha</h4>
      <input id="p-char-name" placeholder="Nome do Her√≥i">
      <input id="p-char-img" placeholder="URL Imagem">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <input id="p-attr-str" type="number" placeholder="FOR">
        <input id="p-attr-dex" type="number" placeholder="DES">
        <input id="p-attr-con" type="number" placeholder="CON">
        <input id="p-attr-int" type="number" placeholder="INT">
      </div>
      <small>Jogadores n√£o editam HP/XP/Invent√°rio diretamente (Pe√ßa ao Mestre).</small>
      <button onclick="saveSheetPlayer()" style="margin-top:10px;">Salvar</button>
    </div>
  </div>

  <div id="store" class="page">
    <div class="header"><button class="back-btn" onclick="back('store')">‚Äπ</button> Loja & Mercado</div>
    <div class="content">
      <div style="display:flex; gap:10px; margin-bottom:10px;">
         <button onclick="toggleStoreTab('sys')" id="tab-sys" style="flex:1;">Sistema</button>
         <button onclick="toggleStoreTab('usr')" id="tab-usr" style="flex:1; background:var(--bg-card); color:var(--text-sub);">Jogadores</button>
      </div>
      
      <div id="store-sys">
         </div>
      
      <div id="store-usr" style="display:none;">
         <div class="card">
           <small>Vender item do seu invent√°rio</small>
           <select id="sell-select"></select>
           <input id="sell-price" type="number" placeholder="Pre√ßo (Ouro)">
           <button onclick="postSellItem()">Anunciar Venda</button>
         </div>
         <div id="market-list"></div>
      </div>
    </div>
  </div>

  <div id="bank" class="page">
    <div class="header"><button class="back-btn" onclick="back('bank')">‚Äπ</button> Banco</div>
    <div class="content">
      <div class="card" style="background: linear-gradient(135deg, #fdd835, #f57f17); color:#000;">
        <h2 id="wallet-gold" style="margin:0; font-size:36px;">0</h2>
        <small style="color:#000; font-weight:bold;">OURO</small>
      </div>
      <div class="card">
        <h4>Transfer√™ncia</h4>
        <input id="transf-key" placeholder="Chave (Key) do Destinat√°rio">
        <input id="transf-amount" type="number" placeholder="Quantidade">
        <button onclick="transferGold()">Enviar Ouro</button>
      </div>
    </div>
  </div>
  
  <div id="chats" class="page">
    <div class="header"><button class="back-btn" onclick="back('chats')">‚Äπ</button> Chats</div>
    <div class="content">
       <div class="card" onclick="openGlobalChat()">
         <b>üåç Global</b><br><small>P√∫blico para todos</small>
       </div>
    </div>
  </div>
  
  <div id="global-chat-view" class="page">
    <div class="header"><button class="back-btn" onclick="back('global-chat-view')">‚Äπ</button> Global</div>
    <div class="chat-container">
       <div id="global-log" class="chat-list"></div>
       <div class="chat-input">
         <input id="global-msg" placeholder="Mensagem..." onkeydown="if(event.key==='Enter') sendGlobalMsg()">
         <button onclick="sendGlobalMsg()">‚û§</button>
       </div>
    </div>
  </div>

  <div id="notes" class="page"><div class="header"><button class="back-btn" onclick="back('notes')">‚Äπ</button> Notas</div><div class="content"><textarea id="notepad" style="flex:1; resize:none;" placeholder="Anota√ß√µes salvas automaticamente..."></textarea><button onclick="saveNote()">Salvar</button></div></div>
  <div id="feed" class="page"><div class="header"><button class="back-btn" onclick="back('feed')">‚Äπ</button> Feed</div><div class="content" id="feed-list"></div></div>

</div>

<script>
// --- CONFIG FIREBASE (Coloque suas credenciais reais aqui se necess√°rio) ---
const firebaseConfig = {
  apiKey: "AIzaSyBykDF5TNKQHejUJTp-ue7s5CKfpJp1HV0",
  authDomain: "mestre-471a0.firebaseapp.com",
  databaseURL: "https://mestre-471a0-default-rtdb.firebaseio.com",
  projectId: "mestre-471a0",
  storageBucket: "mestre-471a0.firebasestorage.app",
  messagingSenderId: "142996111628",
  appId: "1:142996111628:web:c3785e54588632f468c929"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --- ESTADO GLOBAL ---
let currentUser = null;
let userData = {};
let currentTableId = null;
let currentTableData = null;
let pendingJoinId = null;

// --- ITENS DO SISTEMA (Expandido) ---
const SYSTEM_STORE = [
  { cat: "Armas", items: [
      { name: "Adaga", price: 15, desc: "Dano leve, f√°cil de esconder." },
      { name: "Espada Curta", price: 30, desc: "L√¢mina padr√£o." },
      { name: "Espada Longa", price: 50, desc: "Exige duas m√£os ou for√ßa." },
      { name: "Arco Curto", price: 25, desc: "Alcance m√©dio." },
      { name: "Machado de Batalha", price: 55, desc: "Dano pesado." }
  ]},
  { cat: "Armaduras", items: [
      { name: "Roupas de Viajante", price: 5, desc: "Sem prote√ß√£o." },
      { name: "Couro Batido", price: 40, desc: "Prote√ß√£o leve." },
      { name: "Cota de Malha", price: 100, desc: "Prote√ß√£o m√©dia, barulhenta." },
      { name: "Escudo de Madeira", price: 15, desc: "Bloqueio b√°sico." }
  ]},
  { cat: "Consum√≠veis", items: [
      { name: "Po√ß√£o de Cura (P)", price: 20, desc: "Recupera 1d6 HP." },
      { name: "Po√ß√£o de Cura (M)", price: 50, desc: "Recupera 2d6+2 HP." },
      { name: "Ant√≠doto", price: 25, desc: "Cura venenos comuns." },
      { name: "Ra√ß√£o de Viagem", price: 2, desc: "Comida para 1 dia." }
  ]},
  { cat: "Utilit√°rios", items: [
     { name: "Corda (15m)", price: 5, desc: "Essencial." },
      { name: "Tocha", price: 1, desc: "Ilumina por 1 hora." },
      { name: "Mochila", price: 10, desc: "Carrega itens." },
      { name: "Kit de Primeiros Socorros", price: 25, desc: "Estabiliza aliados." }
  ]}
];

// --- INICIALIZA√á√ÉO ---
function init() {
  auth.onAuthStateChanged(u => {
    currentUser = u;
    if (u) {
      document.getElementById('view-login').style.display = 'none';
      document.getElementById('view-user').style.display = 'block';
      loadUserProfile();
      loadTables();
      loadFeed();
      renderSystemStore();
    } else {
      document.getElementById('view-login').style.display = 'block';
      document.getElementById('view-user').style.display = 'none';
    }
  });
}

// --- AUTH & PERFIL ---
async function doLogin() {
  try {
    await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-pass').value);
  } catch(e) { alert("Erro: " + e.message); }
}
async function doRegister() {
  try {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    
    // Schema Inicial do Usu√°rio
    const uid = cred.user.uid;
    const key = uid.substring(0, 6).toUpperCase();
    await db.ref('users/' + uid).set({
      name: "Aventureiro " + key,
      key: key,
      email: email,
      bio: "Novo no sistema.",
      wallet: { gold: 100 },
      char: {
        name: "Sem Nome",
        hp: 20, maxHp: 20, xp: 0,
        str: 10, dex: 10, con: 10, int: 10,
        inv: "Roupas Simples\nAdaga Enferrujada",
        img: ""
      }
    });
  } catch(e) { alert("Erro ao criar: " + e.message); }
}

function loadUserProfile() {
  db.ref('users/' + currentUser.uid).on('value', s => {
    userData = s.val() || {};
    // Header UI
    document.getElementById('u-name').innerText = userData.name;
    document.getElementById('u-key').innerText = userData.key;
    if(userData.img) document.getElementById('u-img').src = userData.img;
    
    // Wallet
    const gold = userData.wallet ? userData.wallet.gold : 0;
    document.getElementById('wallet-gold').innerText = gold;

    // Sheet UI
    const char = userData.char || {};
    document.getElementById('char-name-display').innerText = char.name;
    document.getElementById('char-img-display').src = char.img || "";
    document.getElementById('hp-text').innerText = `${char.hp}/${char.maxHp}`;
    const hpPct = Math.min(100, Math.max(0, (char.hp / char.maxHp) * 100));
    document.getElementById('hp-bar').style.width = hpPct + "%";
    document.getElementById('xp-text').innerText = char.xp;
    document.getElementById('inv-display').innerText = char.inv || "";
    
    document.getElementById('attrs-list').innerHTML = `
      <div class="stat-row"><span>FOR</span><b>${char.str}</b></div>
      <div class="stat-row"><span>DES</span><b>${char.dex}</b></div>
      <div class="stat-row"><span>CON</span><b>${char.con}</b></div>
      <div class="stat-row"><span>INT</span><b>${char.int}</b></div>
    `;

    // Populate Sell Select
    const invList = (char.inv || "").split('\n').filter(i => i.trim().length > 0);
    const sel = document.getElementById('sell-select');
    sel.innerHTML = invList.length ? invList.map(i => `<option>${i}</option>`).join('') : '<option>Vazio</option>';

    // Edit Modal Prefill
    document.getElementById('p-char-name').value = char.name;
    document.getElementById('p-char-img').value = char.img || "";
    document.getElementById('p-attr-str').value = char.str;
    document.getElementById('p-attr-dex').value = char.dex;
    document.getElementById('p-attr-con').value = char.con;
    document.getElementById('p-attr-int').value = char.int;
  });
}

// --- FUN√á√ïES DE MESA ---
function createTable() {
  const name = document.getElementById('new-table-name').value;
  const pass = document.getElementById('new-table-pass').value;
  if (!name) return alert("Nome obrigat√≥rio");
  
  const newRef = db.ref('tables').push();
  newRef.set({
    name: name,
    master: currentUser.uid,
    password: pass, // Simples, em app real usaria hash
    members: { [currentUser.uid]: { name: userData.name, role: 'GM' } },
    created: firebase.database.ServerValue.TIMESTAMP
  });
  document.getElementById('new-table-name').value = "";
  document.getElementById('new-table-pass').value = "";
}

function loadTables() {
  db.ref('tables').limitToLast(20).on('value', s => {
    const div = document.getElementById('tables-list');
    div.innerHTML = "";
    s.forEach(child => {
      const t = child.val();
      const id = child.key;
      const locked = t.password ? "üîí " : "";
      div.innerHTML += `
        <div class="card" style="cursor:pointer; border-left:4px solid #ab47bc" onclick="tryJoinTable('${id}', '${t.password || ''}')">
          <b>${locked}${t.name}</b><br>
          <small>Mestre: ${t.members[t.master]?.name || 'Desconhecido'}</small>
        </div>`;
    });
  });
}

function tryJoinTable(id, pass) {
  pendingJoinId = id;
  if (pass) {
    document.getElementById('modal-table-pass').style.display = 'flex';
  } else {
    joinTable(id);
  }
}

function confirmJoinTable() {
  const input = document.getElementById('join-pass').value;
  db.ref('tables/' + pendingJoinId + '/password').once('value', s => {
    if (s.val() == input) {
      document.getElementById('join-pass').value = "";
      closeModal(null, 'modal-table-pass');
      joinTable(pendingJoinId);
    } else {
      alert("Senha incorreta!");
    }
  });
}

async function joinTable(id) {
  currentTableId = id;
  // Add user to members if not exists
  await db.ref(`tables/${id}/members/${currentUser.uid}`).update({
    name: userData.name,
    role: 'PLAYER' // Default, master overwrites later if needed
  });
  
  // Set Master Role correctly
  db.ref(`tables/${id}/master`).once('value', s => {
    const masterId = s.val();
    if (masterId === currentUser.uid) {
      db.ref(`tables/${id}/members/${currentUser.uid}/role`).set('GM');
      document.getElementById('gm-tools-btn').style.display = 'block';
      loadGmControls();
    } else {
      document.getElementById('gm-tools-btn').style.display = 'none';
      document.getElementById('gm-panel').style.display = 'none';
    }
  });

  // Listener for Table Data
  db.ref(`tables/${id}`).on('value', s => {
    currentTableData = s.val();
    document.getElementById('session-title').innerText = currentTableData.name;
  });

  // Listener for Logs
  loadTableChat(id);
  go('active-session');
}

function leaveTable() {
  currentTableId = null;
  // Detach listeners if you want optimization
  back('active-session');
}

function loadTableChat(id) {
  const div = document.getElementById('session-log');
  div.innerHTML = "";
  db.ref(`tables/${id}/log`).limitToLast(50).on('child_added', s => {
    const m = s.val();
    const isMe = m.uid === currentUser.uid;
    let cls = isMe ? 'me' : 'other';
    if (m.type === 'system') cls = 'system';
    if (m.type === 'narrate') cls = 'narrate';
    
    let html = `<div class="msg ${cls}">`;
    if (m.type !== 'system' && m.type !== 'narrate') html += `<b>${m.u}</b><br>`;
    html += `${m.txt}</div>`;
    
    div.innerHTML += html;
    div.scrollTop = div.scrollHeight;
  });
}

function sendSessionMsg() {
  const txt = document.getElementById('session-msg').value;
  if (!txt || !currentTableId) return;
  
  // Basic Commands Parser
  if (txt.startsWith('/r ') || txt.startsWith('/d ')) {
    handleDice(txt);
  } else if (txt.startsWith('/narrar ') && currentTableData.master === currentUser.uid) {
    pushLog(txt.replace('/narrar ', ''), 'narrate');
  } else {
    pushLog(txt);
  }
  document.getElementById('session-msg').value = "";
}

function pushLog(txt, type = null) {
  db.ref(`tables/${currentTableId}/log`).push({
    u: userData.name,
    uid: currentUser.uid,
    txt: txt,
    type: type,
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}

function handleDice(cmd) {
  // Simple logic: /r 1d20+5
  const roll = Math.floor(Math.random() * 20) + 1;
  pushLog(`üé≤ Rolou dados: [${roll}]`, 'system');
}

// --- GM TOOLS REAIS ---
function loadGmControls() {
  // Populate Player Select
  db.ref(`tables/${currentTableId}/members`).on('value', s => {
    const sel = document.getElementById('gm-target-select');
    sel.innerHTML = "";
    s.forEach(c => {
      if (c.key !== currentUser.uid) { // Don't target self usually
        sel.innerHTML += `<option value="${c.key}">${c.val().name}</option>`;
      }
    });
  });
}

function toggleGmPanel() {
  const p = document.getElementById('gm-panel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

function gmAction(type) {
  const targetUid = document.getElementById('gm-target-select').value;
  if (!targetUid) return alert("Selecione um jogador");
  
  const targetRef = db.ref(`users/${targetUid}/char`);
  
  if (type === 'hp') {
    const val = parseInt(document.getElementById('gm-val-hp').value);
    if (isNaN(val)) return;
    targetRef.child('hp').transaction(curr => {
      let next = (curr || 0) + val;
      // Need maxHp to clamp? Fetch once or accept overhead. Simple addition for now.
      return next; 
    });
    pushLog(`GM alterou HP de ${targetUid.substring(0,4)} em ${val}`, 'system');
  }
  
  if (type === 'xp') {
    const val = parseInt(document.getElementById('gm-val-xp').value);
    if (isNaN(val)) return;
    targetRef.child('xp').transaction(curr => (curr || 0) + val);
    pushLog(`GM deu ${val} XP para o grupo/jogador.`, 'system');
  }
  
  if (type === 'item') {
    const item = document.getElementById('gm-val-item').value;
    if (!item) return;
    targetRef.child('inv').transaction(curr => curr ? curr + "\n" + item : item);
    pushLog(`GM entregou [${item}]`, 'system');
  }
}

// GM INSPECTOR
let inspectingUid = null;
function openGmInspect() {
  inspectingUid = document.getElementById('gm-target-select').value;
  if (!inspectingUid) return alert("Selecione um jogador");
  
  db.ref(`users/${inspectingUid}/char`).once('value', s => {
    const c = s.val();
    document.getElementById('gm-edit-uid').value = inspectingUid;
    document.getElementById('gm-edit-name').value = c.name;
    document.getElementById('gm-edit-hp').value = c.hp;
    document.getElementById('gm-edit-maxhp').value = c.maxHp;
    document.getElementById('gm-edit-inv').value = c.inv;
    
    document.getElementById('modal-gm-inspect').style.display = 'flex';
  });
}

function gmSavePlayer() {
  const uid = document.getElementById('gm-edit-uid').value;
  db.ref(`users/${uid}/char`).update({
    name: document.getElementById('gm-edit-name').value,
    hp: parseInt(document.getElementById('gm-edit-hp').value),
    maxHp: parseInt(document.getElementById('gm-edit-maxhp').value),
    inv: document.getElementById('gm-edit-inv').value
  });
  closeModal(null, 'modal-gm-inspect');
  pushLog("GM atualizou a ficha de um jogador.", "system");
}

// --- LOJA DO SISTEMA & MERCADO ---
function renderSystemStore() {
  const container = document.getElementById('store-sys');
  let html = "";
  
  SYSTEM_STORE.forEach(cat => {
    html += `<h4 style="margin:10px 0 5px; color:var(--primary);">${cat.cat}</h4>`;
    cat.items.forEach(item => {
      html += `
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px;">
        <div>
          <b>${item.name}</b><br>
          <small>${item.desc}</small>
        </div>
        <button onclick="buySystemItem('${item.name}', ${item.price})" style="width:auto; font-size:12px;">${item.price} Ouro</button>
      </div>`;
    });
  });
  container.innerHTML = html;
}

function buySystemItem(name, price) {
  if (userData.wallet.gold < price) return alert("Sem ouro suficiente!");
  
  // Deduz Ouro
  db.ref(`users/${currentUser.uid}/wallet/gold`).set(userData.wallet.gold - price);
  // Adiciona Item
  const newInv = userData.char.inv ? userData.char.inv + "\n" + name : name;
  db.ref(`users/${currentUser.uid}/char/inv`).set(newInv);
  
  alert(`Comprou ${name}!`);
}

function toggleStoreTab(tab) {
  document.getElementById('store-sys').style.display = tab === 'sys' ? 'block' : 'none';
  document.getElementById('store-usr').style.display = tab === 'usr' ? 'block' : 'none';
  document.getElementById('tab-sys').style.background = tab === 'sys' ? 'var(--primary)' : 'var(--bg-card)';
  document.getElementById('tab-usr').style.background = tab === 'usr' ? 'var(--primary)' : 'var(--bg-card)';
  document.getElementById('tab-sys').style.color = tab === 'sys' ? '#fff' : 'var(--text-sub)';
  document.getElementById('tab-usr').style.color = tab === 'usr' ? '#fff' : 'var(--text-sub)';
  
  if (tab === 'usr') loadMarket();
}

function postSellItem() {
  const item = document.getElementById('sell-select').value;
  const price = parseInt(document.getElementById('sell-price').value);
  if (!item || isNaN(price) || price < 1) return alert("Item ou pre√ßo inv√°lido");

  // Remove do invent√°rio
  let invArr = userData.char.inv.split('\n');
  const idx = invArr.indexOf(item);
  if (idx > -1) {
    invArr.splice(idx, 1);
    db.ref(`users/${currentUser.uid}/char/inv`).set(invArr.join('\n'));
    
    // Adiciona ao Mercado
    db.ref('market').push({
      item: item,
      price: price,
      sellerUid: currentUser.uid,
      sellerName: userData.name
    });
    alert("Item anunciado!");
    document.getElementById('sell-price').value = "";
  }
}

function loadMarket() {
  db.ref('market').on('value', s => {
    const div = document.getElementById('market-list');
    div.innerHTML = "";
    s.forEach(child => {
      const sale = child.val();
      if (sale.sellerUid !== currentUser.uid) { // N√£o comprar o pr√≥prio item
        div.innerHTML += `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
          <div><b>${sale.item}</b><br><small>Vend: ${sale.sellerName}</small></div>
          <button onclick="buyMarketItem('${child.key}')" style="width:auto;">${sale.price} Ouro</button>
        </div>`;
      }
    });
    if (!div.innerHTML) div.innerHTML = "<small>Nenhum item √† venda.</small>";
  });
}

function buyMarketItem(key) {
  db.ref(`market/${key}`).once('value', s => {
    const sale = s.val();
    if (!sale) return alert("Item j√° vendido.");
    
    if (userData.wallet.gold < sale.price) return alert("Falta ouro.");
    
    // Transa√ß√£o
    // 1. Tira ouro do comprador
    db.ref(`users/${currentUser.uid}/wallet/gold`).set(userData.wallet.gold - sale.price);
    // 2. D√° ouro ao vendedor
    db.ref(`users/${sale.sellerUid}/wallet/gold`).transaction(v => (v||0) + sale.price);
    // 3. D√° item ao comprador
    db.ref(`users/${currentUser.uid}/char/inv`).transaction(curr => curr ? curr + "\n" + sale.item : sale.item);
    // 4. Remove do mercado
    db.ref(`market/${key}`).remove();
    
    alert("Compra realizada!");
  });
}

// --- TRANSFERENCIA ---
function transferGold() {
  const key = document.getElementById('transf-key').value.toUpperCase();
  const amt = parseInt(document.getElementById('transf-amount').value);
  
  if (userData.wallet.gold < amt) return alert("Saldo insuficiente");
  
  db.ref('users').orderByChild('key').equalTo(key).once('value', s => {
    if (!s.exists()) return alert("Chave inv√°lida");
    const destUid = Object.keys(s.val())[0];
    
    db.ref(`users/${currentUser.uid}/wallet/gold`).set(userData.wallet.gold - amt);
    db.ref(`users/${destUid}/wallet/gold`).transaction(v => (v||0) + amt);
    alert("Enviado!");
  });
}

// --- CHAT GLOBAL ---
function openGlobalChat() {
  go('global-chat-view');
  const div = document.getElementById('global-log');
  div.innerHTML = "";
  db.ref('chat_global').limitToLast(50).on('child_added', s => {
    const m = s.val();
    const isMe = m.uid === currentUser.uid;
    div.innerHTML += `<div class="msg ${isMe ? 'me' : 'other'}"><b>${m.u}</b><br>${m.txt}</div>`;
    div.scrollTop = div.scrollHeight;
  });
}

function sendGlobalMsg() {
  const txt = document.getElementById('global-msg').value;
  if (!txt) return;
  db.ref('chat_global').push({
    u: userData.name, uid: currentUser.uid, txt: txt, ts: firebase.database.ServerValue.TIMESTAMP
  });
  document.getElementById('global-msg').value = "";
}

// --- UTILIT√ÅRIOS GERAIS ---
function openEditSheet() { 
  // Carrega modal normal, mas bloqueia edi√ß√£o de HP/XP se quiser, aqui deixei atributos livres
  document.getElementById('modal-sheet-edit').style.display = 'flex'; 
}
function saveSheetPlayer() {
  db.ref(`users/${currentUser.uid}/char`).update({
    name: document.getElementById('p-char-name').value,
    img: document.getElementById('p-char-img').value,
    str: Number(document.getElementById('p-attr-str').value),
    dex: Number(document.getElementById('p-attr-dex').value),
    con: Number(document.getElementById('p-attr-con').value),
    int: Number(document.getElementById('p-attr-int').value)
  });
  closeModal(null, 'modal-sheet-edit');
}

function openEditProfile() { document.getElementById('modal-profile').style.display = 'flex'; }
function saveProfile() {
  db.ref(`users/${currentUser.uid}`).update({
    name: document.getElementById('edit-name').value,
    img: document.getElementById('edit-img').value,
    bio: document.getElementById('edit-bio').value
  });
  closeModal(null, 'modal-profile');
}

function saveNote() {
  db.ref(`users/${currentUser.uid}/notes`).set(document.getElementById('notepad').value);
  alert("Salvo!");
}

function closeModal(e, id) {
  if (e && e.target.id !== id) return;
  document.getElementById(id).style.display = 'none';
}
function go(id) { 
  document.getElementById(id).classList.add('active'); 
  if(id === 'notes') {
     db.ref(`users/${currentUser.uid}/notes`).once('value', s => document.getElementById('notepad').value = s.val() || "");
  }
}
function back(id) { document.getElementById(id).classList.remove('active'); }

</script>
</body>
</html>
