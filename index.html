<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Mestre</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
/* --- VARI√ÅVEIS E TEMA --- */
:root {
  --primary: #6200ea;
  --primary-contrast: #ffffff;
  --bg-main: #000000;
  --bg-surface: #121212;
  --bg-card: #1e1e1e;
  --text-main: #ffffff;
  --text-sub: #b0b0b0;
  --border: #333333;
  --input-bg: #2c2c2c;
  --danger: #cf6679;
  --success: #03dac6;
  --cmd-bg: #2a2a2a;
}
* { box-sizing: border-box; }
body {
  margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
  background: var(--bg-main);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  user-select: none; transition: background 0.3s; overflow: hidden;
}

/* --- DEVICE & LAYOUT --- */
.device {
  width: 100%; max-width: 400px; height: 100%; max-height: 850px;
  background: var(--bg-main); border-radius: 0;
  position: relative; 
  display: flex; flex-direction: column; overflow: hidden;
}
@media (min-width: 450px) {
  .device { 
    height: 800px; border-radius: 40px; 
    box-shadow: 0 0 0 8px var(--border), 0 0 30px rgba(0,0,0,.7); 
  }
}

.screen {
  width: 100%; height: 100%; background: var(--bg-surface); color: var(--text-main);
  display: flex; flex-direction: column; position: relative;
}
.status-bar {
  height: 30px; display: flex; justify-content: space-between; align-items: center;
  padding: 0 20px; font-size: 12px; font-weight: 600; z-index: 100; opacity: 0.7;
}

/* --- HOME GRID --- */
.app-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px;
  align-content: start; flex: 1; overflow-y: auto;
}
.app-icon { display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:transform .12s;}
.app-icon:active { transform: scale(0.95); }
.icon-box { 
  width:55px; height:55px; background: var(--bg-card); border-radius:14px; 
  display:flex; justify-content:center; align-items:center; font-size:26px; 
  margin-bottom:6px; box-shadow:0 2px 5px rgba(0,0,0,.3); border:1px solid var(--border); 
}
.app-icon span { font-size:11px; text-align:center; color:var(--text-main); }

/* --- P√ÅGINAS --- */
.page { 
  position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-surface); 
  display:flex; flex-direction:column; transform:translateX(100%); 
  transition:transform .3s cubic-bezier(.25, 1, .5, 1); z-index:50; padding-top:80px; 
}
.page.active { transform:translateX(0); }

.header { 
  position:absolute; top:0; left:0; right:0; height:80px; display:flex; align-items:center; 
  padding:0 15px; background:var(--bg-card); border-bottom:1px solid var(--border); 
  font-weight:bold; font-size:18px; flex-shrink:0; color:var(--text-main); z-index:60;
  padding-top: 20px; /* Status bar space */
}
.back-btn { background:none; border:none; font-size:32px; color:var(--primary); margin-right:15px; cursor:pointer; padding:0; line-height:1; }
.content { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; }

/* --- COMPONENTES --- */
.card { 
  background:var(--bg-card); border-radius:12px; padding:15px; margin-bottom:15px; 
  box-shadow:0 2px 4px rgba(0,0,0,.2); border:1px solid var(--border); 
}
input, textarea, select { 
  width:100%; padding:12px; background:var(--input-bg); border:1px solid var(--border); 
  border-radius:8px; color:var(--text-main); font-family:inherit; margin-bottom:10px; 
  box-sizing:border-box; outline:none; font-size: 16px; /* Evita zoom no iOS */
}
input:focus, textarea:focus { border-color: var(--primary); }
button { 
  padding:12px; border-radius:8px; border:none; font-weight:600; cursor:pointer; 
  background:var(--primary); color:var(--primary-contrast); margin-bottom:10px; 
  transition:filter .2s; width:100%; font-size: 14px;
}
button:active { filter: brightness(0.8); }
button.small { padding:6px 10px; font-size:12px; width:auto; margin:0; }

/* --- CHAT --- */
.chat-container { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
.chat-list { 
  flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:12px; 
  scroll-behavior: smooth;
}
.msg { 
  max-width:85%; padding:10px 14px; border-radius:18px; font-size:14px; line-height:1.4; word-wrap:break-word; 
  position: relative;
}
.msg.me { align-self:flex-end; background:var(--primary); color:var(--text-main); border-bottom-right-radius:4px; }
.msg.other { align-self:flex-start; background:var(--bg-card); color:var(--text-main); border:1px solid var(--border); border-bottom-left-radius:4px; }

/* Tipos especiais de msg */
.msg.system { align-self: center; background: transparent; border: 1px dashed var(--border); color: var(--text-sub); font-size: 12px; width: 100%; text-align: center; }
.msg.action { font-style: italic; border-left: 3px solid var(--success); }
.msg.roll { border-color: #ff9800; background: #2a1c05; }
.msg.narrate { background: #1a237e; border: 1px solid #3949ab; color: #fff; width: 100%; text-align: center; font-family: 'Georgia', serif; }

.chat-input { padding:10px; background:var(--bg-card); border-top:1px solid var(--border); display:flex; gap:10px; flex-shrink:0; align-items: center;}

/* --- UTIL --- */
.stat-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:14px; }
.stat-row:last-child { border-bottom: none; }

.modal { 
  position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); 
  z-index:99; display:none; justify-content:center; align-items:center; padding:20px; backdrop-filter: blur(2px);
}
.modal-content { 
  background:var(--bg-surface); padding:20px; border-radius:15px; width:100%; 
  max-width:400px; max-height:90%; overflow-y:auto; border:1px solid var(--primary); 
  box-shadow: 0 0 20px rgba(98, 0, 234, 0.3);
}
small { color:var(--text-sub); font-size: 0.85em; }
.tag { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 10px; vertical-align: middle; }

/* Scrollbar bonito */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body onload="init()">

<div class="device">
  <div class="screen">
    <div class="status-bar">
      <span id="clock">10:00</span>
      <span><span id="battery">100%</span> üîã</span>
    </div>

    <div id="home" class="content" style="padding-top:40px;">
      <h1 style="margin:0 0 20px 20px; font-family:'Brush Script MT', cursive; color:var(--primary); font-size: 2.5rem;">Mestre</h1>
      <div class="app-grid">
        <div class="app-icon" onclick="go('profile')"><div class="icon-box" style="color:#2196f3">üë§</div><span>Perfil</span></div>
        <div class="app-icon" onclick="go('feed')"><div class="icon-box" style="color:#e91e63">üì∞</div><span>Feed</span></div>
        <div class="app-icon" onclick="go('chats')"><div class="icon-box" style="color:#4caf50">üí¨</div><span>Chats</span></div>
        <div class="app-icon" onclick="go('sessions')"><div class="icon-box" style="color:#9c27b0">üé≤</div><span>Sess√µes</span></div>
        <div class="app-icon" onclick="go('sheet')"><div class="icon-box" style="color:#ff9800">üìú</div><span>Ficha</span></div>
        <div class="app-icon" onclick="go('bank')"><div class="icon-box" style="color:#ffeb3b">üè¶</div><span>Banco</span></div>
        <div class="app-icon" onclick="go('store')"><div class="icon-box" style="color:#795548">üõí</div><span>Loja</span></div>
        <div class="app-icon" onclick="go('notes')"><div class="icon-box" style="color:#607d8b">üìù</div><span>Notas</span></div>
        <div class="app-icon" onclick="go('settings')"><div class="icon-box" style="color:var(--text-sub)">‚öôÔ∏è</div><span>Ajustes</span></div>
      </div>
    </div>

    <div id="profile" class="page">
      <div class="header"><button class="back-btn" onclick="back('profile')">‚Äπ</button> Perfil</div>
      <div class="content">
        <div id="view-login">
          <div class="card">
            <h3>Acesso</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="actionLogin()">Entrar</button>
            <button onclick="actionRegister()" style="background:var(--bg-card); border:1px solid var(--border); color:var(--text-main)">Criar Conta</button>
          </div>
        </div>
        <div id="view-user" style="display:none">
          <div class="card" style="text-align:center">
            <img id="u-pic" src="" style="width:90px; height:90px; border-radius:50%; background:var(--border); object-fit:cover; margin:0 auto 10px; display:none; border: 2px solid var(--primary);">
            <h3 id="u-name" style="color:var(--primary); margin: 5px 0;">Nome</h3>
            <p id="u-bio" style="font-size:13px; color:var(--text-sub); margin-bottom: 15px;">Descri√ß√£o</p>
            <button onclick="showModal('profile-edit-modal', true)">Editar Perfil</button>
            <button onclick="actionLogout()" style="background:var(--danger); margin-top:5px;">Sair</button>
          </div>
        </div>
      </div>
    </div>

    <div id="profile-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'profile-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Editar Dados</h4>
        <label><small>Nome de Usu√°rio</small></label>
        <input type="text" id="u-name-edit">
        <label><small>Chave (ID √önico)</small></label>
        <input type="text" id="u-key-edit" readonly style="opacity:0.5">
        <label><small>Cor Hex</small></label>
        <input type="text" id="u-color-edit">
        <label><small>URL Imagem</small></label>
        <input type="text" id="u-img-edit">
        <label><small>Biografia</small></label>
        <textarea id="u-bio-edit"></textarea>
        <button onclick="saveProfile()" style="background:var(--success)">Salvar Altera√ß√µes</button>
        <button onclick="showModal('profile-edit-modal', false)" style="background:var(--bg-card); color:var(--text-main)">Cancelar</button>
      </div>
    </div>

    <div id="feed" class="page">
      <div class="header"><button class="back-btn" onclick="back('feed')">‚Äπ</button> Feed Global</div>
      <div id="feed-list" class="content"></div>
      <button onclick="showModal('post-modal', true)" style="position:absolute; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; font-size:24px; padding:0; z-index:80; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">+</button>
    </div>

    <div id="post-modal" class="modal" onclick="modalBackgroundClick(event, 'post-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Nova Postagem</h4>
        <textarea id="post-txt" rows="5" placeholder="No que est√° pensando?" style="resize:none;"></textarea>
        <input id="post-img" type="text" placeholder="Link da imagem (Opcional)">
        <button onclick="addPost()">Publicar</button>
        <button onclick="showModal('post-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="chats" class="page">
      <div class="header"><button class="back-btn" onclick="back('chats')">‚Äπ</button> Mensagens</div>
      <div class="content">
        <div class="card" onclick="openChat('global')" style="cursor:pointer; display:flex; align-items:center; gap:15px; border-left:4px solid #4caf50;">
          <div style="width:40px; height:40px; background:#4caf50; border-radius:50%; display:flex; justify-content:center; align-items:center;">üåç</div>
          <div><b>Chat Global</b><br><small>Comandos: /ajuda</small></div>
        </div>
        <div class="card" onclick="openPrivateSetup()" style="cursor:pointer; display:flex; align-items:center; gap:15px; border-left:4px solid #2196f3;">
          <div style="width:40px; height:40px; background:#2196f3; border-radius:50%; display:flex; justify-content:center; align-items:center;">üîí</div>
          <div><b>Chat Privado</b><br><small>Mensagens diretas por Chave</small></div>
        </div>
      </div>
    </div>

    <div id="chat-private-setup" class="modal" onclick="modalBackgroundClick(event, 'chat-private-setup')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Iniciar Chat Privado</h4>
        <input type="text" id="dm-key" placeholder="Chave do Destinat√°rio (Ex: JOGADOR1)">
        <button onclick="openPrivateChat()">Abrir Chat</button>
        <button onclick="showModal('chat-private-setup', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="chat-view" class="page">
      <div class="header"><button class="back-btn" onclick="back('chat-view')">‚Äπ</button> <span id="chat-title">Chat</span></div>
      <div class="chat-container">
        <div class="chat-list" id="chat-msgs"></div>
        <div class="chat-input">
          <input id="chat-msg-in" type="text" placeholder="Digite /ajuda para comandos..." style="margin:0" onkeydown="if(event.key==='Enter') sendChat()">
          <button onclick="sendChat()" style="width:50px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sessions" class="page">
      <div class="header"><button class="back-btn" onclick="back('sessions')">‚Äπ</button> Mesas de RPG</div>
      <div class="content">
        <div class="card">
          <h4>Criar Nova Mesa</h4>
          <input id="table-name" type="text" placeholder="Nome da Aventura">
          <button onclick="createTable()">Iniciar Campanha</button>
        </div>
        <h4>Mesas Dispon√≠veis</h4>
        <div id="table-list"></div>
      </div>
    </div>

    <div id="active-session" class="page">
      <div class="header">
        <button class="back-btn" onclick="exitTable()">‚Äπ</button>
        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right: 10px;">
            <span id="session-name">Mesa</span>
        </div>
        <button onclick="toggleGmTools()" id="gm-btn" style="width:auto; background:none; color:var(--primary); display:none; margin:0 0 0 auto; padding:0; font-size:24px;">üõ†Ô∏è</button>
      </div>
      
      <div class="chat-container">
        <div id="gm-panel" style="display:none; background:var(--bg-card); padding:10px; border-bottom:1px solid var(--border); flex-shrink:0;">
          <small>Painel do Mestre</small>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <select id="gm-target" style="margin:0; flex:1;"></select>
            <input id="gm-val" type="text" placeholder="Valor/Item" style="margin:0; flex:1;">
          </div>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button onclick="gmCmd('hp')" style="margin:0;">HP</button>
            <button onclick="gmCmd('xp')" style="margin:0;">XP</button>
            <button onclick="gmCmd('item')" style="margin:0;">Item</button>
          </div>
        </div>

        <div id="session-log" class="chat-list"></div>
        
        <div class="chat-input">
          <input id="session-in" type="text" placeholder="Fale ou use /ajuda..." style="margin:0" onkeydown="if(event.key==='Enter') sendSession()">
          <button onclick="sendSession()" style="width:50px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sheet" class="page">
      <div class="header"><button class="back-btn" onclick="back('sheet')">‚Äπ</button> Ficha</div>
      <div class="content">
        <div class="card" style="text-align:center;">
          <img id="char-pic" src="" style="width:100px; height:100px; border-radius:50%; background:#333; object-fit:cover; margin-bottom:10px; display:none;">
          <h3 id="sheet-name-display">Nome do Her√≥i</h3>
          <p id="sheet-bio-display" style="font-size:12px; color:var(--text-sub)"></p>
        </div>
        <div class="card">
          <h4>Atributos</h4>
          <div id="sheet-attr-display"></div>
        </div>
        <div class="card">
          <h4>Invent√°rio</h4>
          <div id="sheet-inv-display" style="white-space:pre-wrap; font-size:14px; color:var(--text-sub);"></div>
        </div>
        <button onclick="showModal('sheet-edit-modal', true)">Editar Ficha</button>
      </div>
    </div>

    <div id="sheet-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'sheet-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4>Editar Ficha</h4>
        <input id="c-name" type="text" placeholder="Nome do Personagem">
        <input id="c-img" type="text" placeholder="URL da Imagem">
        <textarea id="c-bio" placeholder="Biografia" rows="2"></textarea>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
            <input id="c-str" type="number" placeholder="FOR">
            <input id="c-dex" type="number" placeholder="DES">
            <input id="c-con" type="number" placeholder="CON">
            <input id="c-int" type="number" placeholder="INT">
        </div>
        <textarea id="c-inv" rows="5" placeholder="Invent√°rio (Um item por linha)"></textarea>
        <button onclick="saveSheet()" style="background:var(--success)">Salvar</button>
        <button onclick="showModal('sheet-edit-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="bank" class="page">
      <div class="header"><button class="back-btn" onclick="back('bank')">‚Äπ</button> Banco</div>
      <div class="content">
        <div class="card" style="background: linear-gradient(45deg, #FFD700, #B8860B); color:black; font-weight:bold;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Saldo Ouro</span>
            <span id="gold-val" style="font-size:24px;">0</span>
          </div>
        </div>
        <div class="card">
          <h4>Sua Carteira</h4>
          <div id="wallet-div"></div>
        </div>
        <div class="card">
          <h4>Transferir</h4>
          <input id="pay-key" type="text" placeholder="Chave do Jogador Destino">
          <select id="pay-type">
            <option value="ouro">Ouro</option>
            <option value="prata">Prata</option>
          </select>
          <input id="pay-amt" type="number" placeholder="Quantidade" min="1">
          <button onclick="transfer()">Enviar</button>
        </div>
      </div>
    </div>

    <div id="store" class="page">
      <div class="header"><button class="back-btn" onclick="back('store')">‚Äπ</button> Loja</div>
      <div class="content">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <button onclick="switchStore('sys')" id="btn-sys" style="flex:1;">Sistema</button>
          <button onclick="switchStore('usr')" id="btn-usr" style="flex:1; background:var(--bg-card); color:var(--text-main);">Jogadores</button>
        </div>
        <div id="store-sys">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>‚öîÔ∏è Espada Longa</span>
              <button onclick="buySys('Espada Longa', 50)" style="width:auto; margin:0; padding:5px 10px;">50 Ouro</button>
            </div>
          </div>
          <div class="card">
             <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>üß™ Po√ß√£o de Cura</span>
              <button onclick="buySys('Po√ß√£o de Cura', 10)" style="width:auto; margin:0; padding:5px 10px;">10 Ouro</button>
            </div>
          </div>
          <div class="card">
             <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>üìú Pergaminho</span>
              <button onclick="buySys('Pergaminho', 25)" style="width:auto; margin:0; padding:5px 10px;">25 Ouro</button>
            </div>
          </div>
        </div>
        <div id="store-usr" style="display:none;">
          <div class="card">
            <small>Vender Item</small>
            <select id="sell-item-select"></select>
            <input id="sell-price" type="number" placeholder="Pre√ßo (Ouro)">
            <button onclick="postSell()">Anunciar</button>
          </div>
          <div id="market-list"></div>
        </div>
      </div>
    </div>

    <div id="notes" class="page">
      <div class="header"><button class="back-btn" onclick="back('notes')">‚Äπ</button> Bloco de Notas</div>
      <div class="content">
        <textarea id="note-pad" style="flex:1; resize:none;" placeholder="Suas anota√ß√µes pessoais..."></textarea>
        <button onclick="saveNote()" style="background:var(--success)">Salvar Notas</button>
      </div>
    </div>

    <div id="settings" class="page">
      <div class="header"><button class="back-btn" onclick="back('settings')">‚Äπ</button> Ajustes</div>
      <div class="content">
        <div class="card">
          <h4>Tema</h4>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="setMode('dark')" style="flex:1; background:var(--bg-main);">Escuro</button>
            <button onclick="setMode('light')" style="flex:1; background:#eee; color:#000;">Claro</button>
          </div>
          <h4>Cor de Destaque</h4>
          <input id="color-picker" type="color" value="#6200ea" style="width:100%; height:40px; border:none; border-radius:8px;">
          <button onclick="setAccent(document.getElementById('color-picker').value)" style="margin-top:10px;">Aplicar</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ------------------ CONFIGURA√á√ïES FIREBASE ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBykDF5TNKQHejUJTp-ue7s5CKfpJp1HV0",
  authDomain: "mestre-471a0.firebaseapp.com",
  databaseURL: "https://mestre-471a0-default-rtdb.firebaseio.com",
  projectId: "mestre-471a0",
  storageBucket: "mestre-471a0.firebasestorage.app",
  messagingSenderId: "142996111628",
  appId: "1:142996111628:web:c3785e54588632f468c929"
};

if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let user = null;
let activeChat = null;
let activeTable = null;
let userDataCache = {};

/* ------------------ UTILIT√ÅRIOS ------------------ */
function showModal(id, show) {
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = show ? 'flex' : 'none';
}
function modalBackgroundClick(e, id) {
  if(e.target.id === id) showModal(id, false);
}
function escapeHtml(unsafe) {
  if(typeof unsafe !== 'string') return '';
  return unsafe.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function scrollToBottom(id) {
    setTimeout(() => {
        const el = document.getElementById(id);
        if(el) el.scrollTop = el.scrollHeight;
    }, 100);
}
function rollDice(notation) {
    try {
        const parts = notation.toLowerCase().split('d');
        if(parts.length !== 2) return null;
        let count = parseInt(parts[0]) || 1;
        let rest = parts[1];
        let sides = 0;
        let modifier = 0;

        if(rest.includes('+')) {
            const sp = rest.split('+');
            sides = parseInt(sp[0]);
            modifier = parseInt(sp[1]);
        } else if(rest.includes('-')) {
            const sp = rest.split('-');
            sides = parseInt(sp[0]);
            modifier = -parseInt(sp[1]);
        } else {
            sides = parseInt(rest);
        }

        if(isNaN(count) || isNaN(sides)) return null;
        if(count > 20) count = 20; // Cap para seguran√ßa
        
        let total = 0;
        let rolls = [];
        for(let i=0; i<count; i++) {
            const r = Math.floor(Math.random() * sides) + 1;
            rolls.push(r);
            total += r;
        }
        total += modifier;
        return { total, rolls, modifier, sides, count };
    } catch(e) { return null; }
}

/* ------------------ INIT & AUTH ------------------ */
function init() {
  setInterval(()=>{
    const d = new Date();
    document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }, 1000);

  auth.onAuthStateChanged(u=>{
    user = u;
    if(u) {
      document.getElementById('view-login').style.display = 'none';
      document.getElementById('view-user').style.display = 'block';
      loadUser();
    } else {
      document.getElementById('view-login').style.display = 'block';
      document.getElementById('view-user').style.display = 'none';
    }
  });

  loadFeed();
  loadTables();
}

async function actionLogin(){
  try{
    await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
  } catch(e){ alert('Erro: ' + e.message); }
}

async function actionRegister(){
  try{
    await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
    const uid = auth.currentUser.uid;
    const defaultName = "User_" + uid.substring(0,4);
    db.ref('users/'+uid).set({
      name: defaultName,
      key: defaultName.toUpperCase(),
      color: '#ffffff',
      bio: 'Novo aventureiro.',
      wallet: {ouro:100, prata:0},
      char: {name:'Desconhecido', inv:'', str:10, dex:10, con:10, int:10}
    });
  } catch(e){ alert('Erro: ' + e.message); }
}
function actionLogout(){ auth.signOut(); }

/* ------------------ PERFIL ------------------ */
function loadUser(){
  if(!user) return;
  db.ref('users/'+user.uid).on('value', s=>{
    const d = s.val() || {};
    userDataCache = d; // Cache local para comandos
    const uName = d.name || 'Sem Nome';

    document.getElementById('u-name').innerText = uName;
    document.getElementById('u-name').style.color = d.color || 'var(--primary)';
    document.getElementById('u-bio').innerText = d.bio || '';
    if(d.img) {
      document.getElementById('u-pic').src = d.img;
      document.getElementById('u-pic').style.display = 'block';
    }

    // Edit fields
    document.getElementById('u-name-edit').value = uName;
    document.getElementById('u-key-edit').value = d.key || '';
    document.getElementById('u-color-edit').value = d.color || '#ffffff';
    document.getElementById('u-img-edit').value = d.img || '';
    document.getElementById('u-bio-edit').value = d.bio || '';
    document.getElementById('note-pad').value = d.note || '';

    // Wallet
    if(d.wallet) {
      document.getElementById('gold-val').innerText = d.wallet.ouro || 0;
      let h = '';
      for(let k in d.wallet) h += `<div class="stat-row"><span>${k.charAt(0).toUpperCase()+k.slice(1)}</span><span>${d.wallet[k]}</span></div>`;
      document.getElementById('wallet-div').innerHTML = h;
    }

    // Char
    if(d.char) {
      document.getElementById('sheet-name-display').innerText = d.char.name || 'Sem Nome';
      document.getElementById('sheet-bio-display').innerText = d.char.bio || '';
      document.getElementById('sheet-attr-display').innerHTML = `
        <div class="stat-row"><span>FOR</span><span>${d.char.str||0}</span></div>
        <div class="stat-row"><span>DES</span><span>${d.char.dex||0}</span></div>
        <div class="stat-row"><span>CON</span><span>${d.char.con||0}</span></div>
        <div class="stat-row"><span>INT</span><span>${d.char.int||0}</span></div>
      `;
      document.getElementById('sheet-inv-display').innerText = d.char.inv || 'Vazio';

      // Edit fields char
      document.getElementById('c-name').value = d.char.name || '';
      document.getElementById('c-img').value = d.char.img || '';
      document.getElementById('c-bio').value = d.char.bio || '';
      document.getElementById('c-inv').value = d.char.inv || '';
      document.getElementById('c-str').value = d.char.str || 0;
      document.getElementById('c-dex').value = d.char.dex || 0;
      document.getElementById('c-con').value = d.char.con || 0;
      document.getElementById('c-int').value = d.char.int || 0;

      if(d.char.img) {
        document.getElementById('char-pic').src = d.char.img;
        document.getElementById('char-pic').style.display = 'block';
      }

      // Populate sell select
      const invItems = (d.char.inv || '').split('\n').filter(i => i.trim() !== '');
      const sel = document.getElementById('sell-item-select');
      sel.innerHTML = invItems.length ? invItems.map(i => `<option value="${i}">${i}</option>`).join('') : '<option value="">Vazio</option>';
    }
  });
}

function saveProfile(){
  if(!user) return;
  db.ref('users/'+user.uid).update({
    name: document.getElementById('u-name-edit').value,
    color: document.getElementById('u-color-edit').value,
    img: document.getElementById('u-img-edit').value,
    bio: document.getElementById('u-bio-edit').value
  });
  showModal('profile-edit-modal', false);
}

function saveSheet(){
  if(!user) return;
  db.ref('users/'+user.uid+'/char').update({
    name: document.getElementById('c-name').value,
    img: document.getElementById('c-img').value,
    bio: document.getElementById('c-bio').value,
    inv: document.getElementById('c-inv').value,
    str: Number(document.getElementById('c-str').value),
    dex: Number(document.getElementById('c-dex').value),
    con: Number(document.getElementById('c-con').value),
    int: Number(document.getElementById('c-int').value)
  });
  showModal('sheet-edit-modal', false);
}

function saveNote(){
  if(user) db.ref('users/'+user.uid+'/note').set(document.getElementById('note-pad').value);
  alert('Notas salvas!');
}

/* ------------------ FEED ------------------ */
function addPost(){
  const t = document.getElementById('post-txt').value;
  const i = document.getElementById('post-img').value;
  if(!t) return;
  db.ref('feed').push({
    u: userDataCache.name || 'User',
    uid: user.uid,
    color: userDataCache.color || '#fff',
    txt: t, img: i,
    ts: firebase.database.ServerValue.TIMESTAMP
  });
  document.getElementById('post-txt').value = '';
  document.getElementById('post-img').value = '';
  showModal('post-modal', false);
}

function loadFeed(){
  db.ref('feed').limitToLast(50).on('value', s=>{
    const el = document.getElementById('feed-list');
    el.innerHTML = '';
    const arr = [];
    s.forEach(c=>arr.push(c.val()));
    arr.reverse().forEach(p=>{
        const time = p.ts ? new Date(p.ts).toLocaleString() : '';
        el.innerHTML += `
        <div class="card" style="border-left:4px solid ${p.color}">
          <div style="display:flex; justify-content:space-between;">
             <b style="color:${p.color}">${escapeHtml(p.u)}</b>
             <small>${time}</small>
          </div>
          <p style="margin:5px 0;">${escapeHtml(p.txt)}</p>
          ${p.img ? `<img src="${escapeHtml(p.img)}" style="width:100%; border-radius:8px; margin-top:5px; max-height:200px; object-fit:cover;">` : ''}
        </div>`;
    });
    if(!arr.length) el.innerHTML = '<p style="text-align:center; color:#666">Sem postagens.</p>';
  });
}

/* ------------------ CHAT & COMANDOS ------------------ */

// --- LISTA DE COMANDOS GLOBAIS (10) ---
function handleGlobalCommand(msg, pushFunction) {
    const parts = msg.split(' ');
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1).join(' ');

    switch(cmd) {
        case '/ajuda':
            alert("COMANDOS GLOBAIS:\n/d [x] - Rolar dado\n/eu [a√ß√£o] - Emote\n/moeda - Cara ou Coroa\n/gritar [msg] - Texto destaque\n/sussurro [msg] - Texto discreto\n/mat [conta] - Calculadora\n/data - Hora atual\n/limpar - Limpa tela local\n/status [txt] - Define status\n/r - Atalho para dado");
            return true;
        case '/d':
        case '/r':
            const roll = rollDice(args || '1d20');
            if(roll) {
                pushFunction(`üé≤ Rolou ${args||'1d20'}: [${roll.rolls.join('+')}]${roll.modifier? (roll.modifier>0?'+'+roll.modifier:roll.modifier) : ''} = **${roll.total}**`, 'roll');
            } else {
                alert('Use formato: /d 1d20+5');
            }
            return true;
        case '/eu':
            pushFunction(`* ${userDataCache.name} ${args} *`, 'action');
            return true;
        case '/moeda':
            const res = Math.random() > 0.5 ? 'üëë Cara' : 'ü™ô Coroa';
            pushFunction(`jogou uma moeda e deu: **${res}**`, 'action');
            return true;
        case '/gritar':
            pushFunction(args.toUpperCase(), 'system'); // Reusing system style for boldness logic could be better, but simple push
            return true;
        case '/sussurro':
             pushFunction(`(Sussurro) ${args}`, 'action');
             return true;
        case '/mat':
            try { pushFunction(`üßÆ ${args} = ${eval(args.replace(/[^-()\d/*+.]/g, ''))}`, 'system'); } 
            catch { alert('C√°lculo inv√°lido'); }
            return true;
        case '/data':
            pushFunction(`üïí ${new Date().toLocaleString()}`, 'system');
            return true;
        case '/limpar':
            document.getElementById('chat-msgs').innerHTML = '';
            return true;
        case '/status':
             pushFunction(`est√° se sentindo: ${args}`, 'action');
             return true;
        default:
            return false;
    }
}

// --- LISTA DE COMANDOS DE MESA (10) ---
function handleTableCommand(msg, pushFunction) {
    const parts = msg.split(' ');
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1).join(' ');

    switch(cmd) {
        case '/ajuda':
            alert("COMANDOS DE MESA:\n/r [x] - Rolar dado\n/atacar [alvo] - A√ß√£o de ataque\n/fuga - Tentar fugir\n/inv - Mostrar invent√°rio\n/ouro - Mostrar ouro\n/vida [valor] - Anunciar HP\n/off [txt] - Falar fora do personagem\n/sacar [item] - Empunhar item\n/narrar [txt] - (Destaque)\n/gm [txt] - Falar como Mestre");
            return true;
        case '/r':
            const roll = rollDice(args || '1d20');
            if(roll) {
                pushFunction(`üé≤ Rolou ${args||'1d20'}: **${roll.total}**`, 'roll');
            }
            return true;
        case '/atacar':
            pushFunction(`‚öîÔ∏è ataca ${args || 'o ar'} com ferocidade!`, 'action');
            return true;
        case '/fuga':
            pushFunction(`üèÉ tenta fugir da batalha!`, 'action');
            return true;
        case '/inv':
            pushFunction(`üéí Invent√°rio: ${userDataCache.char ? userDataCache.char.inv.replace(/\n/g, ', ') : 'Vazio'}`, 'system');
            return true;
        case '/ouro':
            pushFunction(`üí∞ Possui ${userDataCache.wallet ? userDataCache.wallet.ouro : 0} pe√ßas de ouro.`, 'system');
            return true;
        case '/vida':
            pushFunction(`‚ù§Ô∏è anuncia que seu HP est√° em: ${args}`, 'action');
            return true;
        case '/off':
            pushFunction(`(( ${args} ))`, 'system');
            return true;
        case '/sacar':
            pushFunction(`üó°Ô∏è saca ${args}!`, 'action');
            return true;
        case '/narrar':
            pushFunction(args, 'narrate');
            return true;
        case '/gm': // Alias visual
             pushFunction(`üëë GM: ${args}`, 'narrate');
             return true;
        default:
            return false;
    }
}

function openChat(id, key = null){
  activeChat = id;
  let path = 'chats/'+id;
  let title = 'Chat Global';
  
  if(id === 'private' && key) {
      const myKey = userDataCache.key;
      const sorted = [myKey, key].sort().join('_');
      path = 'dms/'+sorted;
      title = 'DM: ' + key;
  }
  
  document.getElementById('chat-title').innerText = title;
  go('chat-view');
  
  const ref = db.ref(path).limitToLast(100);
  document.getElementById('chat-msgs').innerHTML = '';
  ref.off();
  ref.on('child_added', s=>{
    const m = s.val();
    const me = m.uid === user.uid;
    const isSys = m.type === 'system' || m.type === 'narrate';
    
    let cls = me ? 'me' : 'other';
    if(m.type) cls += ' ' + m.type;

    let content = escapeHtml(m.txt);
    // Replace markdown-like bold
    content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    let html = `<div class="msg ${cls}">`;
    if(!isSys) html += `<b style="font-size:10px; opacity:0.7; display:block; margin-bottom:2px;">${escapeHtml(m.u)}</b>`;
    html += `${content}</div>`;
    
    const list = document.getElementById('chat-msgs');
    list.innerHTML += html;
    scrollToBottom('chat-msgs');
  });
}

function openPrivateSetup(){ showModal('chat-private-setup', true); }
function openPrivateChat(){
    const k = document.getElementById('dm-key').value.toUpperCase();
    if(k) openChat('private', k);
    showModal('chat-private-setup', false);
}

function sendChat(){
  const inp = document.getElementById('chat-msg-in');
  const txt = inp.value.trim();
  if(!txt || !user) return;
  
  inp.value = '';
  
  // Define push logic to simplify command handler
  const pushMsg = (text, type = null) => {
      let path = 'chats/'+activeChat;
      if(activeChat === 'private') {
           const k = document.getElementById('chat-title').innerText.replace('DM: ','');
           path = 'dms/'+[userDataCache.key, k].sort().join('_');
      }
      db.ref(path).push({
          u: userDataCache.name,
          uid: user.uid,
          txt: text,
          type: type,
          ts: firebase.database.ServerValue.TIMESTAMP
      });
  };

  if(!handleGlobalCommand(txt, pushMsg)) {
      pushMsg(txt);
  }
}

/* ------------------ SESS√ÉO DE RPG ------------------ */
function createTable(){
    const n = document.getElementById('table-name').value;
    if(!n) return;
    const k = db.ref('tables').push().key;
    db.ref('tables/'+k).set({
        name: n,
        master: user.uid,
        users: { [user.uid]: userDataCache.name },
        created: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById('table-name').value = '';
    joinTable(k);
}

function loadTables(){
    db.ref('tables').limitToLast(20).on('value', s=>{
        const el = document.getElementById('table-list');
        el.innerHTML = '';
        s.forEach(c=>{
            const t = c.val();
            el.innerHTML += `<div class="card" onclick="joinTable('${c.key}')" style="cursor:pointer; border-left:4px solid orange"><b>${escapeHtml(t.name)}</b><br><small>Mestre: Humano</small></div>`;
        });
        if(!el.innerHTML) el.innerHTML = '<p>Nenhuma mesa ativa.</p>';
    });
}

function joinTable(k){
    activeTable = k;
    db.ref('tables/'+k).once('value', s=>{
       const t = s.val();
       document.getElementById('session-name').innerText = t.name;
       const isGm = t.master === user.uid;
       document.getElementById('gm-btn').style.display = isGm ? 'block' : 'none';
       if(isGm) loadGmTargets(k);
       go('active-session');
       loadSessionLog(k);
    });
}

function exitTable(){
    activeTable = null;
    back('active-session');
}

function loadGmTargets(k){
    db.ref('tables/'+k+'/users').on('value', s=>{
        const sel = document.getElementById('gm-target');
        sel.innerHTML = '';
        s.forEach(u=> sel.innerHTML += `<option value="${escapeHtml(u.val())}">${escapeHtml(u.val())}</option>`);
    });
}

function toggleGmTools(){
    const p = document.getElementById('gm-panel');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

function gmCmd(type){
    if(!activeTable) return;
    const target = document.getElementById('gm-target').value;
    const val = document.getElementById('gm-val').value;
    let txt = '';
    
    if(type==='hp') txt = `‚ù§Ô∏è alterou HP de ${target} em ${val}`;
    if(type==='xp') txt = `‚ú® concedeu ${val} XP para ${target}`;
    if(type==='item') txt = `üéÅ entregou [${val}] para ${target}`;

    db.ref('tables/'+activeTable+'/log').push({
        u: 'Mestre',
        uid: user.uid,
        txt: txt,
        type: 'narrate',
        ts: firebase.database.ServerValue.TIMESTAMP
    });
}

function loadSessionLog(k){
    const list = document.getElementById('session-log');
    list.innerHTML = '';
    db.ref('tables/'+k+'/log').limitToLast(100).on('child_added', s=>{
        const m = s.val();
        const me = m.uid === user.uid;
        let content = escapeHtml(m.txt);
        // Markdown bold
        content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        let cls = me ? 'me' : 'other';
        if(m.type) cls += ' ' + m.type;

        let html = `<div class="msg ${cls}">`;
        if(m.type !== 'narrate' && m.type !== 'system') html += `<b style="font-size:10px; opacity:0.7; display:block;">${escapeHtml(m.u)}</b>`;
        html += `${content}</div>`;
        
        list.innerHTML += html;
        scrollToBottom('session-log');
    });
}

function sendSession(){
    const inp = document.getElementById('session-in');
    const txt = inp.value.trim();
    if(!txt || !activeTable) return;
    
    inp.value = '';

    const pushMsg = (text, type=null) => {
        db.ref('tables/'+activeTable+'/log').push({
            u: userDataCache.name,
            uid: user.uid,
            txt: text,
            type: type,
            ts: firebase.database.ServerValue.TIMESTAMP
        });
    };

    if(!handleTableCommand(txt, pushMsg)) {
        pushMsg(txt);
    }
}

/* ------------------ LOJA & BANCO ------------------ */
function transfer(){
    const key = document.getElementById('pay-key').value.toUpperCase();
    const amt = Number(document.getElementById('pay-amt').value);
    const type = document.getElementById('pay-type').value;

    if(!key || amt <= 0) return alert('Dados inv√°lidos');

    db.ref('users/'+user.uid+'/wallet/'+type).once('value', s=>{
        const curr = s.val() || 0;
        if(curr < amt) return alert('Saldo insuficiente');
        
        db.ref('users').orderByChild('key').equalTo(key).once('value', r=>{
            if(!r.exists()) return alert('Destinat√°rio n√£o encontrado');
            const destId = Object.keys(r.val())[0];
            
            db.ref('users/'+user.uid+'/wallet/'+type).set(curr - amt);
            db.ref('users/'+destId+'/wallet/'+type).transaction(v=>(v||0)+amt);
            alert('Transfer√™ncia realizada!');
        });
    });
}

function switchStore(m){
  document.getElementById('store-sys').style.display = m==='sys'?'block':'none';
  document.getElementById('store-usr').style.display = m==='usr'?'block':'none';
  document.getElementById('btn-sys').style.background = m==='sys'?'var(--primary)':'var(--bg-card)';
  document.getElementById('btn-usr').style.background = m==='usr'?'var(--primary)':'var(--bg-card)';
  
  if(m==='sys') document.getElementById('btn-usr').style.color = 'var(--text-main)';
  if(m==='usr') document.getElementById('btn-sys').style.color = 'var(--text-main)';
  
  if(m==='usr') loadMarket();
}

function buySys(item, price){
    db.ref('users/'+user.uid+'/wallet/ouro').once('value', s=>{
        const gold = s.val() || 0;
        if(gold >= price){
            db.ref('users/'+user.uid+'/wallet/ouro').set(gold - price);
            db.ref('users/'+user.uid+'/char/inv').transaction(i => (i ? i+'\n'+item : item));
            alert('Comprado!');
        } else alert('Sem ouro.');
    });
}

function postSell(){
    const item = document.getElementById('sell-item-select').value;
    const price = Number(document.getElementById('sell-price').value);
    if(!item || price<=0) return;

    db.ref('users/'+user.uid+'/char/inv').once('value', s=>{
        let inv = (s.val()||'').split('\n');
        const idx = inv.indexOf(item);
        if(idx > -1){
            inv.splice(idx,1);
            db.ref('users/'+user.uid+'/char/inv').set(inv.join('\n'));
            db.ref('market').push({
                s: user.uid,
                u: userDataCache.name,
                i: item,
                p: price
            });
            alert('Anunciado!');
            document.getElementById('sell-item-select').value = '';
        }
    });
}

function loadMarket(){
    db.ref('market').on('value', s=>{
        const d = document.getElementById('market-list');
        d.innerHTML = '';
        s.forEach(c=>{
            const i = c.val();
            if(i.s !== user.uid){
                d.innerHTML += `<div class="card"><div style="display:flex; justify-content:space-between;"><span>${escapeHtml(i.i)}</span><button onclick="buyUsr('${c.key}')" style="width:auto; margin:0; padding:5px;">${i.p} Ouro</button></div><small>Vendedor: ${escapeHtml(i.u)}</small></div>`;
            }
        });
        if(!d.innerHTML) d.innerHTML = '<p>Nenhum item √† venda.</p>';
    });
}

function buyUsr(key){
    db.ref('market/'+key).once('value', s=>{
        if(!s.exists()) return alert('Vendido.');
        const i = s.val();
        db.ref('users/'+user.uid+'/wallet/ouro').once('value', w=>{
            const gold = w.val() || 0;
            if(gold >= i.p){
                db.ref('users/'+user.uid+'/wallet/ouro').set(gold - i.p);
                db.ref('users/'+i.s+'/wallet/ouro').transaction(v=>(v||0)+i.p);
                db.ref('market/'+key).remove();
                db.ref('users/'+user.uid+'/char/inv').transaction(curr => (curr ? curr+'\n'+i.i : i.i));
                alert('Item comprado!');
            } else alert('Falta Ouro');
        });
    });
}

/* ------------------ NAVEGA√á√ÉO ------------------ */
function go(id){ document.getElementById(id).classList.add('active'); }
function back(id){ document.getElementById(id).classList.remove('active'); }

function setMode(m){ 
  const r = document.documentElement.style; 
  if(m==='light'){ 
    r.setProperty('--bg-main','#e0e0e0'); 
    r.setProperty('--bg-surface','#f5f5f5'); 
    r.setProperty('--bg-card','#ffffff'); 
    r.setProperty('--text-main','#000000'); 
    r.setProperty('--border','#cccccc'); 
    r.setProperty('--input-bg','#eeeeee'); 
    r.setProperty('--text-sub','#666666');
  } else { 
    r.setProperty('--bg-main','#000000'); 
    r.setProperty('--bg-surface','#121212'); 
    r.setProperty('--bg-card','#1e1e1e'); 
    r.setProperty('--text-main','#ffffff'); 
    r.setProperty('--border','#333333'); 
    r.setProperty('--input-bg','#2c2c2c'); 
    r.setProperty('--text-sub','#b0b0b0');
  } 
}

function setAccent(c){
  document.documentElement.style.setProperty('--primary', c);
  // Calcula contraste simples
  const hex = c.replace('#','');
  const r = parseInt(hex.substr(0,2),16);
  const g = parseInt(hex.substr(2,2),16);
  const b = parseInt(hex.substr(4,2),16);
  const yiq = ((r*299)+(g*587)+(b*114))/1000;
  document.documentElement.style.setProperty('--primary-contrast', (yiq >= 128) ? 'black' : 'white');
}
</script>
</body>
</html>
