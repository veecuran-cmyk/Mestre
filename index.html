<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Mestre OS</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
:root {
  --primary: #6200ea;
  --primary-contrast: #ffffff;
  --bg-main: #000000;
  --bg-surface: #121212;
  --bg-card: #1e1e1e;
  --text-main: #ffffff;
  --text-sub: #b0b0b0;
  --border: #333333;
  --input-bg: #2c2c2c;
  --danger: #d50000;
  --success: #00c853;
}
*{box-sizing:border-box}
body {
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--bg-main);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  user-select: none;
  transition: background 0.3s;
  overflow: hidden;
}
.device {
  width: 100%;
  height: 100%;
  max-width: 412px;
  max-height: 915px;
  background: var(--bg-main);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.screen {
  width: 100%;
  height: 100%;
  background: var(--bg-surface);
  color: var(--text-main);
  display: flex;
  flex-direction: column;
  transition: background 0.3s, color 0.3s;
  position: relative;
}
.status-bar {
  height: 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  font-size: 12px;
  font-weight: 600;
  z-index: 100;
  background: var(--bg-card);
}
.app-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  padding: 20px;
  align-content: start;
  flex: 1;
  overflow-y: auto;
}
.app-icon { display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:transform .1s;}
.app-icon:active { transform: scale(0.95); }
.icon-box { width:55px; height:55px; background: var(--bg-card); border-radius:14px; display:flex; justify-content:center; align-items:center; font-size:24px; margin-bottom:6px; box-shadow:0 2px 4px rgba(0,0,0,.3); border:1px solid var(--border); }
.app-icon span { font-size:10px; text-align:center; color:var(--text-main); }
.page { position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-surface); display:flex; flex-direction:column; transform:translateX(100%); transition:transform .3s cubic-bezier(.2,.8,.2,1); z-index:50; padding-top:50px; }
.page.active { transform:translateX(0); }
.header { position:absolute; top:0; left:0; right:0; height:50px; display:flex; align-items:center; padding:0 10px; background:var(--bg-card); border-bottom:1px solid var(--border); font-weight:bold; font-size:16px; flex-shrink:0; color:var(--text-main); z-index:60; }
.back-btn { background:none; border:none; font-size:24px; color:var(--primary); margin-right:10px; cursor:pointer; padding:0 10px; line-height:1; }
.content { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; }
.card { background:var(--bg-card); border-radius:12px; padding:12px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,.1); border:1px solid var(--border); }
input, textarea, select { width:100%; padding:10px; background:var(--input-bg); border:1px solid var(--border); border-radius:8px; color:var(--text-main); font-family:inherit; margin-bottom:8px; box-sizing:border-box; font-size: 14px; }
button { padding:10px; border-radius:8px; border:none; font-weight:600; cursor:pointer; background:var(--primary); color:var(--primary-contrast); margin-bottom:8px; transition:opacity .2s; font-size: 14px; }
button:active { opacity: 0.8; }
button.small { padding:5px 8px; font-size:12px; width:auto; }
.chat-container { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.chat-list { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px; }
.msg { max-width:85%; padding:8px 12px; border-radius:12px; font-size:14px; line-height:1.3; word-wrap:break-word; }
.msg.me { align-self:flex-end; background:var(--primary); color:var(--text-main); border-bottom-right-radius:2px; }
.msg.other { align-self:flex-start; background:var(--bg-card); color:var(--text-main); border:1px solid var(--border); border-bottom-left-radius:2px; }
.command-msg { background: #3f51b5; color: white; border-radius: 12px; padding: 6px 10px; max-width: 90%; margin: 4px 0; align-self: center; font-size: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
.chat-input { padding:8px; background:var(--bg-card); border-top:1px solid var(--border); display:flex; gap:8px; flex-shrink:0; }
.stat-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border); font-size:13px; }
.modal { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; padding:20px; backdrop-filter: blur(2px); }
.modal-content { background: var(--bg-surface); padding: 15px; border-radius: 20px; width: 90%; max-width: 320px; max-height: 75%; overflow-y: auto; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
small { color:var(--text-sub); font-size: 0.8em; }
</style>
</head>
<body onload="init()">

<div class="device">
  <div class="screen">
    <div class="status-bar">
      <span id="clock">--:--</span>
      <span><span id="battery">--</span>% üîã</span>
    </div>

    <div id="home" class="content" style="padding-top:40px;">
      <h1 style="margin:0 0 15px 15px; font-family:cursive; color:var(--primary);">Mestre OS</h1>
      <div class="app-grid">
        <div class="app-icon" onclick="go('profile')"><div class="icon-box" style="color:#2196f3">üë§</div><span>Perfil</span></div>
        <div class="app-icon" onclick="go('feed')"><div class="icon-box" style="color:#e91e63">üì∞</div><span>Feed</span></div>
        <div class="app-icon" onclick="go('chats')"><div class="icon-box" style="color:#4caf50">üí¨</div><span>Chats</span></div>
        <div class="app-icon" onclick="go('sessions')"><div class="icon-box" style="color:#9c27b0">üé≤</div><span>Sess√µes</span></div>
        <div class="app-icon" onclick="go('sheet')"><div class="icon-box" style="color:#ff9800">üìú</div><span>Ficha</span></div>
        <div class="app-icon" onclick="go('bank')"><div class="icon-box" style="color:#ffeb3b">üè¶</div><span>Banco</span></div>
        <div class="app-icon" onclick="go('store')"><div class="icon-box" style="color:#795548">üõí</div><span>Loja</span></div>
        <div class="app-icon" onclick="go('notes')"><div class="icon-box" style="color:#607d8b">üìù</div><span>Notas</span></div>
        <div class="app-icon" onclick="go('settings')"><div class="icon-box" style="color:var(--text-sub)">‚öôÔ∏è</div><span>Ajustes</span></div>
      </div>
    </div>

    <div id="profile" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Perfil</div>
      <div class="content">
        <div id="view-login">
          <div class="card">
            <h3>Acesso</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="actionLogin()">Entrar</button>
            <button onclick="actionRegister()" style="background:transparent; border:1px solid var(--border); color:var(--text-main)">Criar Conta</button>
          </div>
        </div>
        <div id="view-user" style="display:none">
          <div class="card" style="text-align:center">
            <img id="u-pic" src="" style="width:70px; height:70px; border-radius:50%; background:var(--border); object-fit:cover; margin:0 auto 10px; display:none;">
            <h3 id="u-name" style="color:var(--primary); margin:5px 0;">Nome</h3>
            <p id="u-bio" style="font-size:12px; color:var(--text-sub); margin:5px 0;">Descri√ß√£o</p>
            <button onclick="showModal('profile-edit-modal', true)" class="small">Editar Perfil</button>
          </div>
          <div class="card">
            <h4>Postagens</h4>
            <div id="profile-feed-list">Carregando...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="profile-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'profile-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4 style="margin-top:0">Editar Perfil</h4>
        <input type="text" id="u-name-edit" placeholder="Nome">
        <input type="text" id="u-key-edit" placeholder="Chave (ID)">
        <input type="text" id="u-color-edit" placeholder="Cor Hex (#RRGGBB)">
        <input type="text" id="u-img-edit" placeholder="URL Imagem">
        <textarea id="u-bio-edit" placeholder="Bio" rows="3"></textarea>
        <button onclick="saveProfile()" style="background:var(--success)">Salvar</button>
        <button onclick="showModal('profile-edit-modal', false)" style="background:var(--danger)">Fechar</button>
        <button onclick="actionLogout()" style="background:var(--border); margin-top:10px">Sair</button>
      </div>
    </div>

    <div id="feed" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Feed</div>
      <div id="feed-list" class="content"></div>
      <button onclick="showModal('post-modal', true)" style="position:absolute; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; font-size:24px; padding:0; box-shadow:0 4px 10px rgba(0,0,0,0.5);">+</button>
    </div>

    <div id="post-modal" class="modal" onclick="modalBackgroundClick(event, 'post-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4 style="margin-top:0">Novo Post</h4>
        <textarea id="post-txt" rows="4" placeholder="Escreva algo..." style="resize:none;"></textarea>
        <input id="post-img" type="text" placeholder="URL Imagem (Opcional)">
        <button onclick="addPost()">Publicar</button>
        <button onclick="showModal('post-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="chats" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Chats</div>
      <div class="content">
        <div class="card" onclick="openChat('global')" style="cursor:pointer; display:flex; align-items:center; gap:10px; border-left:3px solid #4caf50;">
          <div style="font-size:20px;">üåç</div>
          <div><b>Global</b><br><small>P√∫blico</small></div>
        </div>
        <div class="card" onclick="openPrivateSetup()" style="cursor:pointer; display:flex; align-items:center; gap:10px; border-left:3px solid #2196f3;">
          <div style="font-size:20px;">üîí</div>
          <div><b>Privado</b><br><small>Direto</small></div>
        </div>
      </div>
    </div>

    <div id="chat-private-setup" class="modal" onclick="modalBackgroundClick(event, 'chat-private-setup')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4 style="margin-top:0">Novo Chat Privado</h4>
        <input type="text" id="dm-key" placeholder="Chave do Usu√°rio">
        <button onclick="openPrivateChat()">Abrir</button>
        <button onclick="showModal('chat-private-setup', false)" style="background:var(--danger)">Fechar</button>
      </div>
    </div>

    <div id="chat-view" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> <span id="chat-title">Chat</span></div>
      <div class="chat-container">
        <div id="chat-msgs" class="chat-list"></div>
        <div class="chat-input">
          <input id="chat-msg-in" type="text" placeholder="Digite..." style="margin:0" onkeyup="if(event.key==='Enter') sendChat()">
          <button onclick="sendChat()" style="width:40px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sessions" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Sess√µes</div>
      <div class="content">
        <div class="card">
          <h4>Nova Mesa</h4>
          <input id="table-name" type="text" placeholder="Nome">
          <select id="table-type">
            <option value="HUMAN">Mestre Player</option>
            <option value="AI">Mestre IA</option>
          </select>
          <button onclick="createTable()">Criar</button>
        </div>
        <h4>Mesas</h4>
        <div id="table-list"></div>
      </div>
    </div>

    <div id="active-session" class="page">
      <div class="header">
        <button class="back-btn" onclick="exitTable()">‚Äπ</button>
        <span id="session-name" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">Mesa</span>
        <button onclick="toggleGmTools()" id="gm-btn" style="width:auto; background:none; color:var(--primary); display:none; margin-left:auto; font-size:20px; padding:0 10px;">üõ†Ô∏è</button>
      </div>
      <div class="chat-container">
        <div id="gm-panel" style="display:none; background:var(--bg-card); padding:10px; border-bottom:1px solid var(--border);">
          <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="gm-target" style="margin:0; flex:1;"></select>
            <input id="gm-val" type="text" placeholder="Val" style="margin:0; flex:1;">
          </div>
          <div style="display:flex; gap:5px;">
            <button class="small" onclick="gmCmd('hp')">HP</button>
            <button class="small" onclick="gmCmd('item')">Item</button>
          </div>
        </div>
        <div id="session-log" class="chat-list"></div>
        <div class="chat-input">
          <input id="session-in" type="text" placeholder="/roll 1d20 ou a√ß√£o..." style="margin:0" onkeyup="if(event.key==='Enter') sendSession()">
          <button onclick="sendSession()" style="width:40px; margin:0">‚û§</button>
        </div>
      </div>
    </div>

    <div id="sheet" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Ficha</div>
      <div class="content">
        <div class="card" style="text-align:center;">
          <img id="char-pic" src="" style="width:80px; height:80px; border-radius:50%; background:#333; object-fit:cover; display:none; margin:0 auto;">
          <h3 id="sheet-name-display">Nome</h3>
          <p id="sheet-bio-display" style="font-size:12px; color:var(--text-sub)"></p>
        </div>
        <div class="card">
          <h4>Atributos</h4>
          <div id="sheet-attr-display"></div>
        </div>
        <div class="card">
          <h4>Invent√°rio</h4>
          <div id="sheet-inv-display" style="white-space:pre-wrap; font-size:13px;"></div>
        </div>
        <button onclick="showModal('sheet-edit-modal', true)">Editar</button>
      </div>
    </div>

    <div id="sheet-edit-modal" class="modal" onclick="modalBackgroundClick(event, 'sheet-edit-modal')">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h4 style="margin-top:0">Editar Ficha</h4>
        <input id="c-name" type="text" placeholder="Nome Personagem">
        <input id="c-img" type="text" placeholder="URL Imagem">
        <input id="c-str" type="number" placeholder="For√ßa">
        <input id="c-dex" type="number" placeholder="Destreza">
        <input id="c-con" type="number" placeholder="Constitui√ß√£o">
        <input id="c-int" type="number" placeholder="Intelig√™ncia">
        <textarea id="c-inv" rows="4" placeholder="Invent√°rio (1 por linha)"></textarea>
        <button onclick="saveSheet()" style="background:var(--success)">Salvar</button>
        <button onclick="showModal('sheet-edit-modal', false)" style="background:var(--danger)">Cancelar</button>
      </div>
    </div>

    <div id="bank" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Banco</div>
      <div class="content">
        <div class="card" style="background:linear-gradient(45deg, #FFD700, #B8860B); color:black;">
          <div style="display:flex; justify-content:space-between;">
            <b>Ouro</b><span id="gold-val" style="font-size:20px; font-weight:bold">0</span>
          </div>
        </div>
        <div class="card">
          <h4>Carteira</h4>
          <div id="wallet-div"></div>
        </div>
        <div class="card">
          <h4>Transferir</h4>
          <input id="pay-key" placeholder="Chave Destino">
          <select id="pay-type">
            <option value="ouro">Ouro</option><option value="prata">Prata</option><option value="cobre">Cobre</option>
          </select>
          <input id="pay-amt" type="number" placeholder="Qtd">
          <button onclick="transfer()">Enviar</button>
        </div>
      </div>
    </div>

    <div id="store" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Loja</div>
      <div class="content">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <button onclick="switchStore('sys')" id="btn-sys" style="flex:1">Sistema</button>
          <button onclick="switchStore('usr')" id="btn-usr" style="flex:1; background:var(--bg-card)">Players</button>
        </div>
        <div id="store-sys">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>‚öîÔ∏è Espada</span>
              <button class="small" onclick="buySys('Espada', 50)">50 O</button>
            </div>
          </div>
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>üõ°Ô∏è Escudo</span>
              <button class="small" onclick="buySys('Escudo', 30)">30 O</button>
            </div>
          </div>
        </div>
        <div id="store-usr" style="display:none;">
          <div class="card">
            <small>Vender Item</small>
            <select id="sell-item-select"></select>
            <input id="sell-price" type="number" placeholder="Pre√ßo">
            <button onclick="postSell()">Anunciar</button>
          </div>
          <div id="market-list"></div>
        </div>
      </div>
    </div>

    <div id="notes" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Notas</div>
      <div class="content">
        <textarea id="note-pad" style="flex:1; resize:none;" placeholder="Suas anota√ß√µes..."></textarea>
        <button onclick="saveNote()" style="background:var(--success)">Salvar</button>
      </div>
    </div>

    <div id="settings" class="page">
      <div class="header"><button class="back-btn" onclick="back()">‚Äπ</button> Ajustes</div>
      <div class="content">
        <div class="card">
          <h4>Tema</h4>
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="setMode('dark')" style="flex:1; background:#000">Escuro</button>
            <button onclick="setMode('light')" style="flex:1; background:#fff; color:#000">Claro</button>
          </div>
          <h4>Cor</h4>
          <div style="display:flex; gap:5px; align-items:center;">
            <input id="color-picker" type="color" value="#6200ea" style="width:50px; padding:0; height:40px;">
            <button onclick="setAccent(document.getElementById('color-picker').value)" style="flex:1">Aplicar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBykDF5TNKQHejUJTp-ue7s5CKfpJp1HV0",
  authDomain: "mestre-471a0.firebaseapp.com",
  databaseURL: "https://mestre-471a0-default-rtdb.firebaseio.com",
  projectId: "mestre-471a0",
  storageBucket: "mestre-471a0.appspot.com",
  messagingSenderId: "142996111628",
  appId: "1:142996111628:web:c3785e54588632f468c929"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const AI_KEY = "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"; // <--- COLOQUE SUA CHAVE NOVA AQUI

let user = null;
let activeChat = null;
let activeTable = null;

function init() {
  setInterval(()=>{
    const d = new Date();
    document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }, 1000);
  if (navigator.getBattery) {
    navigator.getBattery().then(b => {
      document.getElementById('battery').innerText = Math.round(b.level*100);
    }).catch(()=>{});
  }
  auth.onAuthStateChanged(u=>{
    user = u;
    if(u) {
      document.getElementById('view-login').style.display = 'none';
      document.getElementById('view-user').style.display = 'block';
      loadUser();
    } else {
      document.getElementById('view-login').style.display = 'block';
      document.getElementById('view-user').style.display = 'none';
    }
  });
  loadFeed();
  loadTables();
  const cp = document.getElementById('color-picker');
  if(cp) setAccent(cp.value);
  
  // Push initial state
  history.pushState({page: 'home'}, 'home', '');
}

window.onpopstate = function(event) {
  const openModals = document.querySelectorAll('.modal');
  let modalClosed = false;
  openModals.forEach(m => {
    if(m.style.display === 'flex'){
      m.style.display = 'none';
      modalClosed = true;
    }
  });
  if(modalClosed) {
    history.pushState(null, '', ''); 
    return;
  }

  const activePages = document.querySelectorAll('.page.active');
  if(activePages.length > 0){
    activePages.forEach(p => p.classList.remove('active'));
  }
};

function showModal(id, show) {
  const el = document.getElementById(id);
  if(!el) return;
  if(show){
    el.style.display = 'flex';
    history.pushState({modal: id}, '', '');
  } else {
    el.style.display = 'none';
    history.back();
  }
}

function modalBackgroundClick(e, id) {
  if(e.target && e.target.id === id) showModal(id, false);
}

function go(id){ 
  document.getElementById(id).classList.add('active'); 
  if(id==='store') loadMarket();
  history.pushState({page: id}, '', '');
}

function back(){ 
  const pages = document.querySelectorAll('.page.active');
  pages.forEach(p=>p.classList.remove('active'));
  history.back();
}

async function actionLogin(){
  try{ await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value); } 
  catch(e){ alert(e.message); }
}

async function actionRegister(){
  try{
    await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
    const uid = auth.currentUser.uid;
    db.ref('users/'+uid).set({
      name: uid.substring(0,6),
      key: uid.substring(0,6).toUpperCase(),
      color: '#ffffff',
      wallet: {ouro:100, prata:0, cobre:0},
      char: {name:'Heroi', inv:'Po√ß√£o', str:10, dex:10, con:10, int:10, hp:10, maxHp:10}
    });
  } catch(e){ alert(e.message); }
}

function actionLogout(){ auth.signOut(); }

function loadUser(){
  if(!user) return;
  db.ref('users/'+user.uid).on('value', s=>{
    const d = s.val() || {};
    document.getElementById('u-name').innerText = d.name || 'User';
    document.getElementById('u-name').style.color = d.color || 'var(--primary)';
    document.getElementById('u-bio').innerText = d.bio || '';
    if(d.img) {
      document.getElementById('u-pic').src = d.img;
      document.getElementById('u-pic').style.display = 'block';
    }
    document.getElementById('note-pad').value = d.note || '';
    document.getElementById('u-name-edit').value = d.name;
    document.getElementById('u-key-edit').value = d.key;
    document.getElementById('u-color-edit').value = d.color || '#ffffff';
    document.getElementById('u-img-edit').value = d.img || '';
    document.getElementById('u-bio-edit').value = d.bio || '';

    if(d.wallet) {
      document.getElementById('gold-val').innerText = d.wallet.ouro || 0;
      let h = '';
      for(let k in d.wallet) h += `<div class="stat-row"><span>${k.toUpperCase()}</span><span>${d.wallet[k]}</span></div>`;
      document.getElementById('wallet-div').innerHTML = h;
    }

    if(d.char) {
      document.getElementById('sheet-name-display').innerText = d.char.name || 'Sem Nome';
      document.getElementById('sheet-bio-display').innerText = d.char.bio || '';
      document.getElementById('sheet-attr-display').innerHTML = `
        <div class="stat-row"><span>HP</span><span>${d.char.hp||0}/${d.char.maxHp||0}</span></div>
        <div class="stat-row"><span>FOR</span><span>${d.char.str||0}</span></div>
        <div class="stat-row"><span>DES</span><span>${d.char.dex||0}</span></div>
        <div class="stat-row"><span>CON</span><span>${d.char.con||0}</span></div>
        <div class="stat-row"><span>INT</span><span>${d.char.int||0}</span></div>
      `;
      document.getElementById('sheet-inv-display').innerText = d.char.inv || '';
      document.getElementById('c-name').value = d.char.name||'';
      document.getElementById('c-str').value = d.char.str||0;
      document.getElementById('c-dex').value = d.char.dex||0;
      document.getElementById('c-con').value = d.char.con||0;
      document.getElementById('c-int').value = d.char.int||0;
      document.getElementById('c-inv').value = d.char.inv||'';
      const invItems = (d.char.inv || '').split('\n').filter(i => i.trim() !== '');
      const sel = document.getElementById('sell-item-select');
      if(sel) sel.innerHTML = invItems.map(item => `<option value="${item}">${item}</option>`).join('');
      if(d.char.img){
         document.getElementById('char-pic').src = d.char.img;
         document.getElementById('char-pic').style.display = 'block';
      }
    }
    loadProfileFeed();
  });
}

function saveProfile(){
  if(!user) return;
  db.ref('users/'+user.uid).update({
    name: document.getElementById('u-name-edit').value,
    key: document.getElementById('u-key-edit').value.toUpperCase(),
    color: document.getElementById('u-color-edit').value,
    img: document.getElementById('u-img-edit').value,
    bio: document.getElementById('u-bio-edit').value
  });
  showModal('profile-edit-modal', false);
}

function saveSheet(){
  if(!user) return;
  db.ref('users/'+user.uid+'/char').update({
    name: document.getElementById('c-name').value,
    img: document.getElementById('c-img').value,
    str: Number(document.getElementById('c-str').value),
    dex: Number(document.getElementById('c-dex').value),
    con: Number(document.getElementById('c-con').value),
    int: Number(document.getElementById('c-int').value),
    inv: document.getElementById('c-inv').value
  });
  showModal('sheet-edit-modal', false);
}

function saveNote(){
  if(!user) return;
  db.ref('users/'+user.uid+'/note').set(document.getElementById('note-pad').value);
}

function addPost(){
  if(!user) return;
  db.ref('feed').push({
    u: document.getElementById('u-name').innerText,
    uid: user.uid,
    txt: document.getElementById('post-txt').value,
    img: document.getElementById('post-img').value,
    ts: firebase.database.ServerValue.TIMESTAMP
  }).then(()=>{
    document.getElementById('post-txt').value = '';
    document.getElementById('post-img').value = '';
    showModal('post-modal', false);
  });
}

function loadFeed(){
  db.ref('feed').limitToLast(50).on('value', s=>{
    const d = document.getElementById('feed-list');
    d.innerHTML = '';
    const p = [];
    s.forEach(c => p.push(c.val()));
    p.sort((a,b)=>(b.ts||0)-(a.ts||0));
    p.forEach(x => d.innerHTML += renderPost(x));
  });
}

function loadProfileFeed(){
  if(!user) return;
  db.ref('feed').orderByChild('uid').equalTo(user.uid).limitToLast(20).on('value', s=>{
    const d = document.getElementById('profile-feed-list');
    d.innerHTML = '';
    const p = [];
    s.forEach(c => p.push(c.val()));
    p.sort((a,b)=>(b.ts||0)-(a.ts||0));
    p.forEach(x => d.innerHTML += renderPost(x));
  });
}

function renderPost(p){
  return `<div class="card" style="border-left:3px solid ${p.color||'var(--primary)'}">
    <small>${p.u}</small><br>${p.txt}
    ${p.img?`<img src="${p.img}" style="width:100%;border-radius:8px;margin-top:5px">`:''}
  </div>`;
}

function openChat(id, rKey=null){
  activeChat = id;
  let p = 'chats/'+id;
  if(id === 'private'){
    const myKey = document.getElementById('u-key-edit').value.toUpperCase();
    const keys = [myKey, rKey].sort();
    p = 'dms/'+keys[0]+'_'+keys[1]+'/msg';
    document.getElementById('chat-title').innerText = 'DM: '+rKey;
  } else {
    document.getElementById('chat-title').innerText = 'Global';
  }
  go('chat-view');
  const d = document.getElementById('chat-msgs');
  d.innerHTML = '';
  db.ref(p).limitToLast(50).off();
  db.ref(p).limitToLast(50).on('child_added', s=>{
    const m = s.val();
    const me = m.uid===user.uid;
    const cls = m.isCmd ? 'command-msg' : (me?'me':'other');
    d.innerHTML += `<div class="msg ${cls}">${m.isCmd?m.txt:`<b>${m.u}</b><br>${m.txt}`}</div>`;
    d.scrollTop = d.scrollHeight;
  });
}

function openPrivateSetup(){ showModal('chat-private-setup', true); }

async function openPrivateChat(){
  const k = document.getElementById('dm-key').value.toUpperCase();
  const u = await db.ref('users').orderByChild('key').equalTo(k).once('value');
  if(u.exists()){
    openChat('private', k);
    showModal('chat-private-setup', false);
  } else alert('Key not found');
}

async function handleCommand(txt, ctx){
  const [cmd, ...argsArr] = txt.split(' ');
  const args = argsArr.join(' ');
  const uName = document.getElementById('u-name').innerText;
  const uData = (await db.ref('users/'+user.uid).once('value')).val();
  const char = uData.char || {};

  if(cmd === '/roll' || cmd === '/r'){
    const m = args.match(/^(\d+)?d(\d+)([\+\-]\d+)?$/i);
    if(!m) return {u:uName, txt:`Uso: /roll 1d20+5`};
    let n=parseInt(m[1]||1), sides=parseInt(m[2]), mod=parseInt(m[3]||0), tot=mod, rolls=[];
    for(let i=0;i<n;i++){ let r=Math.floor(Math.random()*sides)+1; rolls.push(r); tot+=r; }
    return {u:uName, txt:`üé≤ ${args}: **${tot}** (${rolls.join('+')}${mod?((mod>0?'+':'')+mod):''})`};
  }
  if(cmd==='/sheet'){
    return {u:uName, txt:`üìú **${char.name}**\nHP:${char.hp}/${char.maxHp} STR:${char.str} DEX:${char.dex} CON:${char.con} INT:${char.int}`};
  }
  if(cmd==='/inv'){
    return {u:uName, txt:`üéí **Inv:**\n${char.inv||'Vazio'}`};
  }
  if(cmd==='/use'){
    let inv = (char.inv||'').split('\n');
    let idx = inv.findIndex(i=>i.toLowerCase().includes(args.toLowerCase()));
    if(idx>-1){
      let it = inv.splice(idx,1)[0];
      db.ref('users/'+user.uid+'/char/inv').set(inv.join('\n'));
      return {u:uName, txt:`‚ú® Usou **${it}**`};
    }
    return {u:uName, txt:`Item n√£o encontrado`};
  }
  return {u:uName, txt:`Comando inv√°lido`};
}

async function sendChat(){
  const t = document.getElementById('chat-msg-in').value;
  if(!t) return;
  document.getElementById('chat-msg-in').value = '';
  if(t.startsWith('/')){
     const res = await handleCommand(t, 'chat');
     if(res){
       let p = activeChat==='private'? 'dms/'+getDmId()+'/msg' : 'chats/global';
       db.ref(p).push({u:res.u, uid:user.uid, txt:res.txt, isCmd:true});
     }
     return;
  }
  let p = activeChat==='private'? 'dms/'+getDmId()+'/msg' : 'chats/global';
  db.ref(p).push({u:document.getElementById('u-name').innerText, uid:user.uid, txt:t});
}

function getDmId(){
  const myKey = document.getElementById('u-key-edit').value.toUpperCase();
  const rKey = document.getElementById('chat-title').innerText.replace('DM: ','');
  return [myKey, rKey].sort().join('_');
}

function createTable(){
  const k = db.ref('tables').push().key;
  db.ref('tables/'+k).set({
    name: document.getElementById('table-name').value,
    type: document.getElementById('table-type').value,
    master: user.uid,
    users: {[user.uid]: document.getElementById('u-name').innerText}
  });
  joinTable(k);
}

function loadTables(){
  db.ref('tables').on('value', s=>{
    const d = document.getElementById('table-list');
    d.innerHTML = '';
    s.forEach(x=>{
      const t = x.val();
      d.innerHTML += `<div class="card" onclick="joinTable('${x.key}')"><b>${t.name}</b> (${t.type})</div>`;
    });
  });
}

function joinTable(k){
  activeTable = k;
  go('active-session');
  db.ref('tables/'+k).once('value', s=>{
    const t = s.val();
    document.getElementById('session-name').innerText = t.name;
    const isGm = t.master === user.uid && t.type === 'HUMAN';
    document.getElementById('gm-btn').style.display = isGm?'block':'none';
    if(isGm){
       const sel = document.getElementById('gm-target');
       sel.innerHTML='';
       for(let uid in t.users) sel.innerHTML+=`<option value="${uid}">${t.users[uid]}</option>`;
    }
  });
  const d = document.getElementById('session-log');
  d.innerHTML='';
  db.ref('tables/'+k+'/log').limitToLast(50).off();
  db.ref('tables/'+k+'/log').limitToLast(50).on('child_added', s=>{
    const m = s.val();
    const me = m.uid===user.uid;
    const cls = m.isCommand ? 'command-msg' : (me?'me':'other');
    d.innerHTML += `<div class="msg ${cls}">${m.isCommand?m.txt:`<b>${m.u}</b><br>${m.txt}`}</div>`;
    d.scrollTop = d.scrollHeight;
  });
}

function exitTable(){ activeTable=null; back(); }
function toggleGmTools(){ 
  const p=document.getElementById('gm-panel'); p.style.display=p.style.display==='none'?'block':'none'; 
}
function gmCmd(act){
  const u = document.getElementById('gm-target').value;
  const v = document.getElementById('gm-val').value;
  if(act==='hp') db.ref('users/'+u+'/char/hp').transaction(c=>(c||0)+Number(v));
  if(act==='item') db.ref('users/'+u+'/char/inv').transaction(c=>(c||'')+'\n'+v);
  db.ref('tables/'+activeTable+'/log').push({u:'GM', uid:'sys', txt:`GM: ${act} ${v}`, isCommand:true});
}

async function sendSession(){
  const t = document.getElementById('session-in').value;
  if(!t || !activeTable) return;
  document.getElementById('session-in').value = '';

  if(t.startsWith('/')){
    const res = await handleCommand(t, 'session');
    if(res) db.ref('tables/'+activeTable+'/log').push({u:res.u, uid:user.uid, txt:res.txt, isCommand:true});
    return;
  }

  db.ref('tables/'+activeTable+'/log').push({u:document.getElementById('u-name').innerText, uid:user.uid, txt:t, ts:firebase.database.ServerValue.TIMESTAMP});

  const tData = (await db.ref('tables/'+activeTable).once('value')).val();
  if(tData.type === 'AI'){
    try {
      if(AI_KEY.length < 10) return; 
      const logSnap = await db.ref('tables/'+activeTable+'/log').limitToLast(8).once('value');
      const msgs = [];
      logSnap.forEach(s => {
        const m = s.val();
        if(!m.isCommand) msgs.push({role: m.uid==='ai'?'assistant':'user', content: m.uid==='ai'?m.txt:`[${m.u}]: ${m.txt}`});
      });
      
      const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${AI_KEY}`,
          "Content-Type": "application/json",
          "HTTP-Referer": "https://mestre-os.app",
          "X-Title": "Mestre OS"
        },
        body: JSON.stringify({
          model: "tngtech/deepseek-r1t2-chimera",
          messages: [{role:"system", content:"Mestre de RPG medieval."}, ...msgs]
        })
      });

      if(!resp.ok) throw new Error(resp.status);
      const j = await resp.json();
      const txt = j.choices[0].message.content;
      db.ref('tables/'+activeTable+'/log').push({u:'Mestre IA', uid:'ai', txt:txt, ts:firebase.database.ServerValue.TIMESTAMP});
    } catch(e){
      console.error(e);
      db.ref('tables/'+activeTable+'/log').push({u:'Sys', uid:'ai', txt:'Erro IA: '+e.message, isCommand:true});
    }
  }
}

function transfer(){
  const k = document.getElementById('pay-key').value.toUpperCase();
  const t = document.getElementById('pay-type').value;
  const v = Number(document.getElementById('pay-amt').value);
  db.ref('users/'+user.uid+'/wallet/'+t).once('value', s=>{
    if((s.val()||0)>=v){
      db.ref('users').orderByChild('key').equalTo(k).once('value', u=>{
        if(u.exists()){
           const d = Object.keys(u.val())[0];
           db.ref('users/'+user.uid+'/wallet/'+t).set(s.val()-v);
           db.ref('users/'+d+'/wallet/'+t).transaction(c=>(c||0)+v);
        }
      });
    }
  });
}

function switchStore(m){
  document.getElementById('store-sys').style.display = m==='sys'?'block':'none';
  document.getElementById('store-usr').style.display = m==='usr'?'block':'none';
}
function buySys(i, p){
  db.ref('users/'+user.uid+'/wallet/ouro').once('value', s=>{
    if((s.val()||0)>=p){
      db.ref('users/'+user.uid+'/wallet/ouro').set(s.val()-p);
      db.ref('users/'+user.uid+'/char/inv').transaction(c=>(c||'')+'\n'+i);
    }
  });
}
function postSell(){
  db.ref('market').push({
    s: user.uid,
    u: document.getElementById('u-name').innerText,
    i: document.getElementById('sell-item-select').value,
    p: document.getElementById('sell-price').value,
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}
function loadMarket(){
  db.ref('market').limitToLast(20).on('value', s=>{
    const d = document.getElementById('market-list');
    d.innerHTML='';
    s.forEach(x=>{
      const i = x.val();
      if(i.s!==user.uid) d.innerHTML+=`<div class="card"><span>${i.i} (${i.p} O)</span><button onclick="buyUsr('${x.key}', '${i.i}', ${i.p})">Comprar</button></div>`;
    });
  });
}
function buyUsr(k, i, p){
  db.ref('users/'+user.uid+'/wallet/ouro').once('value', s=>{
    if((s.val()||0)>=p){
      db.ref('market/'+k).once('value', mSnap=>{
         const m = mSnap.val();
         db.ref('users/'+user.uid+'/wallet/ouro').set(s.val()-p);
         db.ref('users/'+m.s+'/wallet/ouro').transaction(v=>(v||0)+p);
         db.ref('users/'+user.uid+'/char/inv').transaction(c=>(c||'')+'\n'+i);
         db.ref('market/'+k).remove();
      });
    }
  });
}

function hexToRgb(h){const i=parseInt(h.replace('#',''),16);return{r:(i>>16)&255,g:(i>>8)&255,b:i&255};}
function setAccent(c){
  document.documentElement.style.setProperty('--primary', c);
  const rgb=hexToRgb(c);
  const yiq=((rgb.r*299)+(rgb.g*587)+(rgb.b*114))/1000;
  document.documentElement.style.setProperty('--primary-contrast', yiq>=128?'#000':'#fff');
}
function setMode(m){
  const r = document.documentElement.style;
  if(m==='light'){
    r.setProperty('--bg-main','#e0e0e0'); r.setProperty('--bg-surface','#f5f5f5');
    r.setProperty('--bg-card','#ffffff'); r.setProperty('--text-main','#000');
    r.setProperty('--border','#ccc'); r.setProperty('--input-bg','#eee');
  } else {
    r.setProperty('--bg-main','#000'); r.setProperty('--bg-surface','#121212');
    r.setProperty('--bg-card','#1e1e1e'); r.setProperty('--text-main','#fff');
    r.setProperty('--border','#333'); r.setProperty('--input-bg','#2c2c2c');
  }
}
</script>
</body>
</html>
